<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>majm的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="做一些简单的笔记">
<meta property="og:type" content="website">
<meta property="og:title" content="majm的博客">
<meta property="og:url" content="https://majunmin.github.io/page/2/index.html">
<meta property="og:site_name" content="majm的博客">
<meta property="og:description" content="做一些简单的笔记">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="majm">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="majm的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">majm的博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://majunmin.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Go源码-context" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/Go%E6%BA%90%E7%A0%81-context.html" class="article-date">
  <time datetime="2022-08-30T15:39:07.000Z" itemprop="datePublished">2022-08-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/Go%E6%BA%90%E7%A0%81-context.html">Go源码-context</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在go服务器中,通常 每个传入的请求都会在自己的<code>goroutine</code>中进行处理. 请求处理程序通常会启动额外的<code>goroutine</code>来访问数据库 或者第三方服务.<br>处理请求的一组<code>goroutine</code>通常需要访问特定于请求的值: 例如<code>userid</code>, <code>request_id</code>, <code>token</code>,<code>timeout</code>…,当请求被取消或者超时时,所有处理该请求的goroutine都应该快速退出. 以便系统可以快速回收他们正在使用的任何资源.</p>
<p><a target="_blank" rel="noopener" href="https://pkg.go.dev/context">context</a> 是 go 1.14 引入 的一个概念. 用于解决上述问题.</p>
        
          <p class="article-more-link">
            <a href="/post/Go%E6%BA%90%E7%A0%81-context.html#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://majunmin.github.io/post/Go%E6%BA%90%E7%A0%81-context.html" data-id="clamitdev000pm9nr8ux57b2n" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/context/" rel="tag">context</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" rel="tag">源码剖析</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-微服务-Trace" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/%E5%BE%AE%E6%9C%8D%E5%8A%A1-Trace.html" class="article-date">
  <time datetime="2022-08-18T04:46:07.000Z" itemprop="datePublished">2022-08-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/%E5%BE%AE%E6%9C%8D%E5%8A%A1-Trace.html">微服务 Trace</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Spection-Trace-语义"><a href="#Spection-Trace-语义" class="headerlink" title="Spection  Trace 语义"></a>Spection  Trace 语义</h2><h3 id="Trace"><a href="#Trace" class="headerlink" title="Trace"></a>Trace</h3><p>代表一个调用链.</p>
<p>通常， 一个 Trace 可以被理解为一系列span 组成的有向无环图(DAG), span 之间的边称为  Reference.</p>
<h3 id="Span"><a href="#Span" class="headerlink" title="Span"></a>Span</h3><p><code>Span</code> 表示一个跨进程的 RPC 或者进程内部的一个过程.</p>
<p>每个span 可以包含一些状态:<br><code>operate_name</code><br><code>start_timestampe</code><br><code>end_timestamp</code><br><code>Tags</code>: 一系列 kv 集合<br><code>Logs</code>: 一系列 kv 集合,并且携带时间戳<br><code>SpanContext</code>:<br><code>Reference</code>: 通过 SpanContext 关联其他 Span</p>
<h3 id="SpanContext"><a href="#SpanContext" class="headerlink" title="SpanContext"></a>SpanContext</h3><p>SpanContext  封装了一个可以用来指向特定 Span 的状态,用于在进程间(内)传递. 通过在进程间传递,在分布式环境中构建一个DAG图.</p>
<p>span 必须去提供方法访问 <code>SpanContext</code>,<code>SpanContext</code> 代表跨越进程边界,传递到下级Span的状态.(包含  <code>trace_id</code> <code>span_id</code> <code>sampled</code> 元组).</p>
<p><code>SpanContext</code> 在跨越进程边界,和在追踪图中创建边界的时候会使用.</p>
<h3 id="Logs"><a href="#Logs" class="headerlink" title="Logs"></a>Logs</h3><p> 每个<code>Span</code>可以进行多次Logs操作,每一次Logs操作, 都需要一个带<code>时间戳</code>的时间名称, 以及可选的任意大小的存储结构.<br><a target="_blank" rel="noopener" href="https://github.com/opentracing/specification/blob/master/semantic_conventions.md#log-fields-table">Standard LogKeys</a></p>
<h3 id="Tags"><a href="#Tags" class="headerlink" title="Tags"></a>Tags</h3><p>每个 <code>Span</code> 可以有多个键值对(key:value)形式的<code>Tags</code>, <code>Tags</code>是没有时间戳的,支持简单的对<code>Span</code>进行注解和补充.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/opentracing/specification/blob/master/semantic_conventions.md#span-tags-table">Standard Tags</a></p>
<h3 id="Baggage"><a href="#Baggage" class="headerlink" title="Baggage"></a>Baggage</h3><p><code>Baggage</code> 是存储在 <code>SpanContext</code> 中的一个键值对(SpanContext)集合. 它会在一条追踪链路上的所有span内全局传输. 在这种情况下, <code>Baggage</code>会随着Trace一同传播.(<code>Baggage</code>可理解为随着<code>trace</code>运行过程传送的行李).</p>
<p><code>Baggage</code> 拥有强大功能,也会有很大的消耗.  由于Baggage的全局传输,如果包含的数量量太大，或者元素太多，它将降低系统的吞吐量或增加RPC的延迟.</p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p>Reference 有两种类型:</p>
<ul>
<li>ChildOf</li>
<li>FollowsFrom</li>
</ul>
<hr>
<p><a target="_blank" rel="noopener" href="https://opentracing-contrib.github.io/opentracing-specification-zh/specification.html">OpenTracing语义标准</a><br><a target="_blank" rel="noopener" href="https://opentracing.io/specification/">The OpenTracing Semantic Specification</a><br><a target="_blank" rel="noopener" href="https://github.com/opentracing/specification/blob/master/specification.md">The OpenTracing Semantic Specification-github</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://majunmin.github.io/post/%E5%BE%AE%E6%9C%8D%E5%8A%A1-Trace.html" data-id="clamitdfj003qm9nr0daihk4h" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/trace/" rel="tag">trace</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag">微服务</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-微服务-API-Gateway" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/%E5%BE%AE%E6%9C%8D%E5%8A%A1-API-Gateway.html" class="article-date">
  <time datetime="2022-08-17T02:52:25.000Z" itemprop="datePublished">2022-08-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/%E5%BE%AE%E6%9C%8D%E5%8A%A1-API-Gateway.html">微服务:API Gateway</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="什么是-API网关"><a href="#什么是-API网关" class="headerlink" title="什么是 API网关"></a>什么是 API网关</h2><p>API网关是一个服务器,是系统的唯一入口.  从面向对象设计的角度看，它与外观模式类似.</p>
<p>API网关封装了系统内部架构,为每个客户端提供一个定制的API.它可能还具有其它职责,如身份验证、监控、负载均衡、缓存、协议转换、限流熔断、静态响应处理.</p>
<p>API网关方式的核心要点是: 所有的客户端和消费端都通过统一的网关接入微服务,在网关层处理所有的非业务功能. 通常，网关也是提供<code>REST/HTTP</code>的访问API.</p>
<h2 id="网关应该具有那些能力"><a href="#网关应该具有那些能力" class="headerlink" title="网关应该具有那些能力"></a>网关应该具有那些能力</h2><p>微服务网关作为微服务后端服务的统一入口, 它可以统筹管理后端服务,主要分为<code>数据平面</code>和<code>控制平面</code>:</p>
<p><code>数据平面</code>主要功能是接入用户的HTTP请求和微服务被拆分后的聚合.使用微服务网关统一对外暴露后端服务的API和契约,路由和过滤功能正是网关的核心能力模块.另外,<strong>微服务网关可以实现拦截机制和专注跨横切面的功能</strong>,包括协议转换、安全认证、熔断限流、灰度发布、日志管理、流量监控等.</p>
<p><code>控制平面</code>主要功能是对后端服务做统一的管控和配置管理.例如,可以控制网关的弹性伸缩; 可以统一下发配置; 可以对网关服务添加标签; 可以在微服务网关上通过配置Swagger功能统一将后端服务的API契约暴露给使用方, 完成文档服务, 提高工作效率和降低沟通成本.</p>
<ul>
<li>限流</li>
<li>熔断</li>
<li>安全</li>
<li>缓存</li>
<li>重试</li>
<li>负载均衡</li>
<li>反向路由</li>
<li>认证,鉴权</li>
<li>日志收集</li>
<li>监控</li>
<li>IP列表:黑名单,白名单</li>
<li>流量染色</li>
<li>协议转换</li>
<li>API管理</li>
</ul>
<p>下图 是 Kong 官方  的一个简单架构图.</p>
<p><img src="https://cdn.jsdelivr.net/gh/majunmin/image/etcd/20220818200500.png"></p>
<h2 id="常见的开源网关对比"><a href="#常见的开源网关对比" class="headerlink" title="常见的开源网关对比"></a>常见的开源网关对比</h2><table>
<thead>
<tr>
<th>功能</th>
<th>Apache APISIX</th>
<th>Kong</th>
<th>Tyk</th>
</tr>
</thead>
<tbody><tr>
<td>项目归属</td>
<td>Apache</td>
<td>Kong Inc</td>
<td></td>
</tr>
<tr>
<td>技术架构</td>
<td>Nginx + etcd</td>
<td>Nginx + postgres</td>
<td>Golang + Redis</td>
</tr>
<tr>
<td>部署模式</td>
<td>单机&amp;集群</td>
<td>单机&amp;集群</td>
<td>单机&amp;集群</td>
</tr>
<tr>
<td>单核Qps(开启限流和 prometheus)</td>
<td>18,000</td>
<td>1700</td>
<td></td>
</tr>
<tr>
<td>平均延时</td>
<td>0.2ms</td>
<td>2ms</td>
<td></td>
</tr>
<tr>
<td>配置生效时间</td>
<td>时间通知, 低于 1ms</td>
<td>定时轮询 5s</td>
<td></td>
</tr>
<tr>
<td>支持配置回滚</td>
<td>[x]</td>
<td>[]</td>
<td></td>
</tr>
<tr>
<td>热插件更新</td>
<td>[x]</td>
<td>[]</td>
<td></td>
</tr>
<tr>
<td>用户自定义负载均衡算法，路由</td>
<td>[x]</td>
<td>[]</td>
<td>[]</td>
</tr>
<tr>
<td>控制台</td>
<td>[x]</td>
<td>[]</td>
<td>[]</td>
</tr>
</tbody></table>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://majunmin.github.io/post/%E5%BE%AE%E6%9C%8D%E5%8A%A1-API-Gateway.html" data-id="clamitdfi003nm9nr7m8t5z5e" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gateway/" rel="tag">gateway</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag">微服务</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-awesome-blog" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/awesome-blog.html" class="article-date">
  <time datetime="2022-08-16T12:45:48.000Z" itemprop="datePublished">2022-08-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/awesome-blog.html">awesome-blog</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="golang"><a href="#golang" class="headerlink" title="golang"></a>golang</h2><p><a target="_blank" rel="noopener" href="https://geektutu.com/">极客兔兔</a><br><a target="_blank" rel="noopener" href="https://eddycjy.gitbook.io/golang/">跟煎鱼学Go</a><br><a target="_blank" rel="noopener" href="https://changkun.de/blog/">O神的博客</a><br><a target="_blank" rel="noopener" href="https://xargin.com/">曹大的博客</a></p>
<h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><p><a target="_blank" rel="noopener" href="https://mercyblitz.github.io/">小马哥的技术博客</a><br>田小波的技术博客</p>
<h2 id="Architech"><a href="#Architech" class="headerlink" title="Architech"></a>Architech</h2><p><a target="_blank" rel="noopener" href="https://cleancoders.com/">cleancoders</a><br><a target="_blank" rel="noopener" href="https://www.jdon.com/">解道</a><br><a target="_blank" rel="noopener" href="http://icyfenix.cn/summary/">凤凰架构</a></p>
<h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><p><a target="_blank" rel="noopener" href="https://frimin.com/">FRIMIN</a><br><a target="_blank" rel="noopener" href="https://linux.vbird.org/">鸟哥的首页</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/vamei/">Vamei</a></p>
<h2 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h2><p><a target="_blank" rel="noopener" href="https://tanxinyu.work/">谭新宇</a><br><a target="_blank" rel="noopener" href="https://labuladong.github.io/algo/">LABULADONG 的算法网站</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/v_JULY_v">结构之法算法之道</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/kuangbin/">kuangbin - 博客园</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/acm_cxlove">acm_cxlove</a><br><a target="_blank" rel="noopener" href="https://www.shuizilong.com/house/">某岛</a><br><a target="_blank" rel="noopener" href="http://blog.acmicpc.info/">ACMer 博客瀑布流</a><br><a target="_blank" rel="noopener" href="https://godweiyang.com/categories/">伟阳的博客</a></p>
<h2 id="大厂博客"><a href="#大厂博客" class="headerlink" title="大厂博客"></a>大厂博客</h2><p><a target="_blank" rel="noopener" href="https://tech.meituan.com/">美团技术团队</a><br><a target="_blank" rel="noopener" href="http://140.205.61.252/">阿里中间件团队博客</a><br><a target="_blank" rel="noopener" href="https://tech.youzan.com/">有赞技术团队</a><br><a target="_blank" rel="noopener" href="https://insights.thoughtworks.cn/">Thoughtworks洞见</a><br><a target="_blank" rel="noopener" href="https://xiaomi-info.github.io/">小米信息部技术团队</a><br><a target="_blank" rel="noopener" href="https://tech.ipalfish.com/blog/">伴鱼技术团队</a></p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p><a target="_blank" rel="noopener" href="https://maiyang.me/">茶歇驿站</a><br><a target="_blank" rel="noopener" href="https://www.qtmuniao.com/">木鸟杂记</a><br><a target="_blank" rel="noopener" href="https://shuyi.tech/">陈树义的博客</a><br><a target="_blank" rel="noopener" href="https://coolshell.cn/">左耳朵耗子的博客</a></p>
<h2 id="Golang-书籍"><a href="#Golang-书籍" class="headerlink" title="Golang 书籍"></a><strong>Golang 书籍</strong></h2><p><a target="_blank" rel="noopener" href="http://books.studygolang.com/gopl-zh/">Go语言圣经（中文版）</a><br><a target="_blank" rel="noopener" href="https://golang.coding3min.com/">Go语言精进之路</a><br><a target="_blank" rel="noopener" href="https://golang.design/under-the-hood/">Go 语言原本</a><br><a target="_blank" rel="noopener" href="https://chai2010.cn/advanced-go-programming-book/">Go语言高级编程(Advanced Go Programming)</a><br><a target="_blank" rel="noopener" href="https://draveness.me/golang/">语言设计与实现</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/qcrao-Go-Questions/README.md">Go 语言问题集(Go Questions)</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://majunmin.github.io/post/awesome-blog.html" data-id="clamitdf6001um9nrg219go3k" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/blog/" rel="tag">blog</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-golang-sync-Pool解析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/golang-sync-Pool%E8%A7%A3%E6%9E%90.html" class="article-date">
  <time datetime="2022-08-11T17:15:26.000Z" itemprop="datePublished">2022-08-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/golang-sync-Pool%E8%A7%A3%E6%9E%90.html">golang-sync.Pool解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>sync.Pool是sync包下的一个组件,可以作为临时取还对象的一个 <code>池子</code>.</p>
<p>作用: 对于很多需要重复分配、回收内存的地方,<code>sync.Pool</code> 是一个很好的选择.频繁地分配、回收内存会给 GC 带来一定的负担,严重的时候会引起 CPU 的毛刺,<strong>而 <code>sync.Pool</code> 可以将暂时不用的对象缓存起来m待下次需要的时候直接使用,不用再次经过内存分配,复用对象的内存,减轻 GC 的压力,提升系统的性能.</strong></p>
<p>使用场景:</p>
<ol>
<li>当多个 goroutine 都需要创建同⼀个对象的时候，如果 goroutine 数过多,导致对象的创建数⽬剧增,进⽽导致 GC 压⼒增大.形成”并发⼤－占⽤内存⼤－GC 缓慢－处理并发能⼒降低－并发更⼤”这样的恶性循环.</li>
<li>关键思想就是对象的复用,避免重复创建.销毁.</li>
</ol>
<h2 id="Pool原理详解"><a href="#Pool原理详解" class="headerlink" title="Pool原理详解"></a>Pool原理详解</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Pool <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	noCopy noCopy

	local     unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// local fixed-size per-P pool, actual type is [P]poolLocal</span>
	localSize <span class="token builtin">uintptr</span>        <span class="token comment">// size of the local array</span>

	victim     unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// local from previous cycle</span>
	victimSize <span class="token builtin">uintptr</span>        <span class="token comment">// size of victims array</span>

	<span class="token comment">// New optionally specifies a function to generate</span>
	<span class="token comment">// a value when Get would otherwise return nil.</span>
	<span class="token comment">// It may not be changed concurrently with calls to Get.</span>
	New <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> any
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<ul>
<li>noCopy:</li>
<li>local:   每个P的本地队列,实际类型为 <code>[P]poolLocal</code></li>
<li>localSize: </li>
<li>victicm:</li>
<li>victicmSize: </li>
<li>New:      自定义创建对象的回调函数,当pool中没有都可用对象时会调用</li>
</ul>
<h3 id="1-noCopy"><a href="#1-noCopy" class="headerlink" title="1. noCopy"></a>1. noCopy</h3><p>nocopy:<br>因为Pool不希望被复制,所以结构体里面有一个<code>noCopy</code>字段, 使用 <code>go vet</code> 工具可以检查用户是否复制了 Pool.</p>
<p>用户只需要实现这样不需要消耗内存的,仅用于静态分析的结构, 保证对象在第一次使用后不会发生复制.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// noCopy may be embedded into structs which must not be copied</span>
<span class="token comment">// after the first use.</span>
<span class="token comment">// noCopy 可以被嵌入结构体来保证其第一次使用后不会在被复制.</span>
<span class="token comment">//</span>
<span class="token comment">// See https://golang.org/issues/8005#issuecomment-190753527</span>
<span class="token comment">// for details.</span>
<span class="token keyword">type</span> noCopy <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token comment">// Lock is a no-op used by -copylocks checker from `go vet`.</span>
<span class="token comment">// Lock 是一个空操作用来给 `go ve` 的 -copylocks 静态分析</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>noCopy<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>noCopy<span class="token punctuation">)</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="2-local"><a href="#2-local" class="headerlink" title="2. local"></a>2. local</h3><p>local字段指向  <code>[P]poolLocal</code> 数组(切片)的指针, localSize 则表示 这个数组的大小. 访问时 P 的 id 对应 <code>[P]poolLocal</code> 下标索引, 这样的设计减少了 多个goroutine 的竞争,提升了性能.</p>
<h4 id="2-1-poolLocal"><a href="#2-1-poolLocal" class="headerlink" title="2.1 poolLocal"></a>2.1 poolLocal</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> poolLocal <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	poolLocalInternal

	<span class="token comment">// 将 poolLocal 补齐至两个缓存行的倍数，防止 false sharing,</span>
	<span class="token comment">// 每个缓存行具有 64 bytes，即 512 bit$$</span>
	<span class="token comment">// 目前我们的处理器一般拥有 32 * 1024 / 64 = 512 条缓存行</span>
	<span class="token comment">// 伪共享，仅占位用,防止在 cache line 上分配多个 poolLocalInternal</span>
	<span class="token comment">// </span>
	<span class="token comment">// Prevents false sharing on widespread platforms with$$</span>
	<span class="token comment">// 128 mod (cache line size) = 0 .</span>
	pad <span class="token punctuation">[</span><span class="token number">128</span> <span class="token operator">-</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>poolLocalInternal<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<h4 id="2-2-poolLocalInternal"><a href="#2-2-poolLocalInternal" class="headerlink" title="2.2 poolLocalInternal"></a>2.2 poolLocalInternal</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token comment">// Local per-P Pool appendix.</span>
<span class="token keyword">type</span> poolLocalInternal <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	private any       <span class="token comment">// Can be used only by the respective P.  仅能被各自的 P 获取</span>
	shared  poolChain <span class="token comment">// Local P can pushHead/popHead; any P can popTail. 本地P可以从头部取, 其他 P 从尾部取</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<h4 id="2-3-poolChain"><a href="#2-3-poolChain" class="headerlink" title="2.3 poolChain"></a>2.3 poolChain</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token comment">// poolChain is a dynamically-sized version of poolDequeue.</span>
<span class="token comment">//</span>
<span class="token comment">// This is implemented as a doubly-linked list queue of poolDequeues</span>
<span class="token comment">// where each dequeue is double the size of the previous one. Once a</span>
<span class="token comment">// dequeue fills up, this allocates a new one and only ever pushes to</span>
<span class="token comment">// the latest dequeue. Pops happen from the other end of the list and</span>
<span class="token comment">// once a dequeue is exhausted, it gets removed from the list.</span>
<span class="token keyword">type</span> poolChain <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// head is the poolDequeue to push to. This is only accessed</span>
	<span class="token comment">// by the producer, so doesn't need to be synchronized.</span>
	head <span class="token operator">*</span>poolChainElt

	<span class="token comment">// tail is the poolDequeue to popTail from. This is accessed</span>
	<span class="token comment">// by consumers, so reads and writes must be atomic.</span>
	tail <span class="token operator">*</span>poolChainElt
<span class="token punctuation">&#125;</span>



<span class="token keyword">type</span> poolChainElt <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	poolDequeue

	<span class="token comment">// next and prev link to the adjacent poolChainElts in this</span>
	<span class="token comment">// poolChain.</span>
	<span class="token comment">//</span>
	<span class="token comment">// next is written atomically by the producer and read</span>
	<span class="token comment">// atomically by the consumer. It only transitions from nil to</span>
	<span class="token comment">// non-nil.</span>
	<span class="token comment">//</span>
	<span class="token comment">// prev is written atomically by the consumer and read</span>
	<span class="token comment">// atomically by the producer. It only transitions from</span>
	<span class="token comment">// non-nil to nil.</span>
	next<span class="token punctuation">,</span> prev <span class="token operator">*</span>poolChainElt
<span class="token punctuation">&#125;</span>

<span class="token comment">// </span>
<span class="token comment">// poolDequeue is a lock-free fixed-size single-producer,</span>
<span class="token comment">// multi-consumer queue. The single producer can both push and pop</span>
<span class="token comment">// from the head, and consumers can pop from the tail.</span>
<span class="token comment">//</span>
<span class="token comment">// It has the added feature that it nils out unused slots to avoid</span>
<span class="token comment">// unnecessary retention of objects. This is important for sync.Pool,</span>
<span class="token comment">// but not typically a property considered in the literature.</span>
<span class="token keyword">type</span> poolDequeue <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// headTail 包含一个 32 位的 head 和一个 32 位的 tail 指针. 这两个值都和 len(vals)-1 取模过.</span>
	<span class="token comment">// tail 是队列中最老的数据,head 指向下一个将要填充的 slot</span>
    <span class="token comment">// slots 的有效范围是 [tail, head),由 consumers 持有.</span>
	<span class="token comment">// </span>
	<span class="token comment">// headTail packs together a 32-bit head index and a 32-bit</span>
	<span class="token comment">// tail index. Both are indexes into vals modulo len(vals)-1.</span>
	<span class="token comment">//</span>
	<span class="token comment">// tail = index of oldest data in queue</span>
	<span class="token comment">// head = index of next slot to fill</span>
	<span class="token comment">//</span>
	<span class="token comment">// Slots in the range [tail, head) are owned by consumers.</span>
	<span class="token comment">// A consumer continues to own a slot outside this range until</span>
	<span class="token comment">// it nils the slot, at which point ownership passes to the</span>
	<span class="token comment">// producer.</span>
	<span class="token comment">//</span>
	<span class="token comment">// The head index is stored in the most-significant bits so</span>
	<span class="token comment">// that we can atomically add to it and the overflow is</span>
	<span class="token comment">// harmless.</span>
	headTail <span class="token builtin">uint64</span>

	<span class="token comment">// </span>
	<span class="token comment">// vals 是一个存储 interface&#123;&#125; 的环形队列,它的 size 必须是 2 的幂</span>
	<span class="token comment">// 如果 slot 为空,则 vals[i].typ 为空;否则，非空.</span>
	<span class="token comment">// 一个 slot 在这时宣告无效: tail 不指向它了，vals[i].typ 为 nil</span>
	<span class="token comment">// 由 consumer 设置成 nil，由 producer 读</span>
	<span class="token comment">// </span>
	<span class="token comment">// vals is a ring buffer of interface&#123;&#125; values stored in this</span>
	<span class="token comment">// dequeue. The size of this must be a power of 2.</span>
	<span class="token comment">//</span>
	<span class="token comment">// vals[i].typ is nil if the slot is empty and non-nil</span>
	<span class="token comment">// otherwise. A slot is still in use until *both* the tail</span>
	<span class="token comment">// index has moved beyond it and typ has been set to nil. This</span>
	<span class="token comment">// is set to nil atomically by the consumer and read</span>
	<span class="token comment">// atomically by the producer.</span>
	vals <span class="token punctuation">[</span><span class="token punctuation">]</span>eface
<span class="token punctuation">&#125;</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<blockquote><span class="custom-blockquote-svg"><svg width="24" height="24" viewBox="0 0 24 24" fill="" xmlns="http://www.w3.org/2000/svg" data-reactroot="">
<path fill="" d="M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z" undefined="1"></path>
<path fill="" d="M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z" undefined="1"></path>
<path fill="" d="M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z" undefined="1"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z"></path>
</svg>
</span><p>poolDequeue 被设计成单生产者，多消费者固定长度&amp;&amp;无锁的 双端队列.<br>   producer 可以从head插入和删除.  consumer可以从尾部pop 数据.</p></blockquote>
<blockquote><span class="custom-blockquote-svg"><svg width="24" height="24" viewBox="0 0 24 24" fill="" xmlns="http://www.w3.org/2000/svg" data-reactroot="">
<path fill="" d="M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z" undefined="1"></path>
<path fill="" d="M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z" undefined="1"></path>
<path fill="" d="M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z" undefined="1"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z"></path>
</svg>
</span><p>headTail 指向队头和队尾, 通过位运算, 将 head  &amp; tail 存入  headTail中.</p></blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/majunmin/image/etcd/20220815203335.png" alt="Pool结构体"></p>
<p><img src="https://cdn.jsdelivr.net/gh/majunmin/image/etcd/20220815203400.png"></p>
<blockquote><span class="custom-blockquote-svg"><svg width="24" height="24" viewBox="0 0 24 24" fill="" xmlns="http://www.w3.org/2000/svg" data-reactroot="">
<path fill="" d="M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z" undefined="1"></path>
<path fill="" d="M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z" undefined="1"></path>
<path fill="" d="M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z" undefined="1"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z"></path>
</svg>
</span><p>我们看到 Pool 并没有直接使用 <code>poolDequeue</code>,原因是它的大小是固定的,而 Pool 的大小是没有限制的.<br>因此，在 <code>poolDequeue</code> 之上包装了一下,变成了一个 <code>poolChainElt</code> 的双向链表,可以动态增长.</p></blockquote>
<h3 id="3-victim"><a href="#3-victim" class="headerlink" title="3. victim"></a>3. victim</h3><p>一轮 GC 完成后,victim 和 victimSize 会分别接管  local  和 localSize,victim 的机制用于减少GC后冷启动导致的性能抖动. 让分配对象更加平滑.</p>
<blockquote><span class="custom-blockquote-svg"><svg width="24" height="24" viewBox="0 0 24 24" fill="" xmlns="http://www.w3.org/2000/svg" data-reactroot="">
<path fill="" d="M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z" undefined="1"></path>
<path fill="" d="M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z" undefined="1"></path>
<path fill="" d="M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z" undefined="1"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z"></path>
</svg>
</span><p>victim Cache 本来是计算机架构里面的一个概念,是让CPU硬件处理缓存的一种技术, <code>sync.Pool</code>引入的意图在于 降低GC压力的同时增加缓存命中率.</p></blockquote>
<h3 id="4-New"><a href="#4-New" class="headerlink" title="4. New"></a>4. New</h3><p>当Pool中没有对象可供提供时,会调用 New 生成一个新对象.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>




<h2 id="2-源码详解"><a href="#2-源码详解" class="headerlink" title="2. 源码详解"></a>2. 源码详解</h2><h3 id="2-1-Get"><a href="#2-1-Get" class="headerlink" title="2.1. Get"></a>2.1. Get</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Get selects an arbitrary item from the Pool, removes it from the</span>
<span class="token comment">// Pool, and returns it to the caller.</span>
<span class="token comment">// Get may choose to ignore the pool and treat it as empty.</span>
<span class="token comment">// Callers should not assume any relation between values passed to Put and</span>
<span class="token comment">// the values returned by Get.</span>
<span class="token comment">//</span>
<span class="token comment">// If Get would otherwise return nil and p.New is non-nil, Get returns</span>
<span class="token comment">// the result of calling p.New.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> any <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">&#123;</span>
		race<span class="token punctuation">.</span><span class="token function">Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// 将当前的 goroutine 和 P绑定,禁止被强占,返回当前P对应的 localPool &amp; pid</span>
	l<span class="token punctuation">,</span> pid <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">pin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	x <span class="token operator">:=</span> l<span class="token punctuation">.</span>private
	l<span class="token punctuation">.</span>private <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// Try to pop the head of the local shard. We prefer</span>
		<span class="token comment">// the head over the tail for temporal locality of</span>
		<span class="token comment">// reuse.</span>
		x<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> l<span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">popHead</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// 尝试从 qita P 的 shared 双端队列尾部头一个对象出来.</span>
			x <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">getSlow</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// pool 操作完成之后, 接触非抢占</span>
	<span class="token function">runtime_procUnpin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">&#123;</span>
		race<span class="token punctuation">.</span><span class="token function">Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> x <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			race<span class="token punctuation">.</span><span class="token function">Acquire</span><span class="token punctuation">(</span><span class="token function">poolRaceAddr</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 如果最后还是没有获取到缓存对象,那就直接调用预先设置好的回调函数 `New` 创建一个对象.</span>
	<span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>New <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		x <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> x
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p><img src="https://cdn.jsdelivr.net/gh/majunmin/image/etcd/20220815204610.png"></p>
<h4 id="2-1-1-pin"><a href="#2-1-1-pin" class="headerlink" title="2.1.1 pin"></a>2.1.1 pin</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// pin pins the current goroutine to P, disables preemption and</span>
<span class="token comment">// returns poolLocal pool for the P and the P's id.</span>
<span class="token comment">// Caller must call runtime_procUnpin() when done with the pool.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token function">pin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>poolLocal<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	pid <span class="token operator">:=</span> <span class="token function">runtime_procPin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// In pinSlow we store to local and then to localSize, here we load in opposite order.</span>
	<span class="token comment">// Since we've disabled preemption, GC cannot happen in between.</span>
	<span class="token comment">// Thus here we must observe local at least as large localSize.</span>
	<span class="token comment">// We can observe a newer/larger local, it is fine (we must observe its zero-initialized-ness).</span>
	s <span class="token operator">:=</span> <span class="token function">runtime_LoadAcquintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>localSize<span class="token punctuation">)</span> <span class="token comment">// load-acquire</span>
	l <span class="token operator">:=</span> p<span class="token punctuation">.</span>local                              <span class="token comment">// load-consume</span>
	<span class="token comment">// 因为可能存在动态的 P（运行时调整 P 的个数）</span>
	<span class="token keyword">if</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span> <span class="token operator">&lt;</span> s <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">indexLocal</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">,</span> pid
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">pinSlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>调用方必须在完成取值后,调用 <code>runtime.proc_Unpin()</code> 来取消抢占.</p>
<blockquote><span class="custom-blockquote-svg"><svg width="24" height="24" viewBox="0 0 24 24" fill="" xmlns="http://www.w3.org/2000/svg" data-reactroot="">
<path fill="" d="M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z" undefined="1"></path>
<path fill="" d="M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z" undefined="1"></path>
<path fill="" d="M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z" undefined="1"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z"></path>
</svg>
</span><p>pin 的作用就是将当前 groutine 和 P 绑定在一起，禁止抢占. 并且返回对应的 poolLocal 以及 P 的 id。</p></blockquote>
<p>如果 G 被抢占，则 G 的状态从 running 变成 runnable,会被放回 P 的 localq 或 globaq，等待下一次调度.<br>下次再执行时，就不一定是和现在的 P 相结合了. 因为之后会用到 pid,如果被抢占了,有可能接下来使用的 pid 与所绑定的 P 并非同一个.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token function">pinSlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>poolLocal<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// Retry under the mutex.</span>
	<span class="token comment">// Can not lock the mutex while pinned.</span>
	<span class="token function">runtime_procUnpin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	allPoolsMu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> allPoolsMu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	pid <span class="token operator">:=</span> <span class="token function">runtime_procPin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// poolCleanup won't be called while we are pinned.</span>
	s <span class="token operator">:=</span> p<span class="token punctuation">.</span>localSize
	l <span class="token operator">:=</span> p<span class="token punctuation">.</span>local
	<span class="token keyword">if</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span> <span class="token operator">&lt;</span> s <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">indexLocal</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">,</span> pid
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> p<span class="token punctuation">.</span>local <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		allPools <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>allPools<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// If GOMAXPROCS changes between GCs, we re-allocate the array and lose the old one.</span>
	size <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">GOMAXPROCS</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	local <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>poolLocal<span class="token punctuation">,</span> size<span class="token punctuation">)</span>
	atomic<span class="token punctuation">.</span><span class="token function">StorePointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>local<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>local<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// store-release</span>
	<span class="token function">runtime_StoreReluintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>localSize<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment">// store-release</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>local<span class="token punctuation">[</span>pid<span class="token punctuation">]</span><span class="token punctuation">,</span> pid
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因为有一把大锁 <code>allPoolsMu</code>, 所以函数名带有 slow. 锁粒度越大,竞争越多,就越慢.  不过想要上锁的话,先要解除绑定.  原因是锁越大,被阻塞的概率越大,如果还占着 P, 那就浪费资源.</p>
<h4 id="2-1-2-popHead"><a href="#2-1-2-popHead" class="headerlink" title="2.1.2 popHead"></a>2.1.2 popHead</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>poolChain<span class="token punctuation">)</span> <span class="token function">pushHead</span><span class="token punctuation">(</span>val any<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	d <span class="token operator">:=</span> c<span class="token punctuation">.</span>head
	<span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// Initialize the chain.</span>
		<span class="token keyword">const</span> initSize <span class="token operator">=</span> <span class="token number">8</span> <span class="token comment">// Must be a power of 2</span>
		d <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>poolChainElt<span class="token punctuation">)</span>
		d<span class="token punctuation">.</span>vals <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>eface<span class="token punctuation">,</span> initSize<span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>head <span class="token operator">=</span> d
		<span class="token function">storePoolChainElt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>tail<span class="token punctuation">,</span> d<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> d<span class="token punctuation">.</span><span class="token function">pushHead</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// The current dequeue is full. Allocate a new one of twice</span>
	<span class="token comment">// the size.</span>
	newSize <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span>
	<span class="token keyword">if</span> newSize <span class="token operator">>=</span> dequeueLimit <span class="token punctuation">&#123;</span>
		<span class="token comment">// Can't make it any bigger.</span>
		newSize <span class="token operator">=</span> dequeueLimit
	<span class="token punctuation">&#125;</span>

	d2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>poolChainElt<span class="token punctuation">&#123;</span>prev<span class="token punctuation">:</span> d<span class="token punctuation">&#125;</span>
	d2<span class="token punctuation">.</span>vals <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>eface<span class="token punctuation">,</span> newSize<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>head <span class="token operator">=</span> d2
	<span class="token function">storePoolChainElt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>next<span class="token punctuation">,</span> d2<span class="token punctuation">)</span>
	d2<span class="token punctuation">.</span><span class="token function">pushHead</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>poolChain<span class="token punctuation">)</span> <span class="token function">popHead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>any<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	d <span class="token operator">:=</span> c<span class="token punctuation">.</span>head
	<span class="token keyword">for</span> d <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// 调用 dequeue 的 popHead</span>
		<span class="token keyword">if</span> val<span class="token punctuation">,</span> ok <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">popHead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> val<span class="token punctuation">,</span> ok
		<span class="token punctuation">&#125;</span>
		<span class="token comment">// There may still be unconsumed elements in the</span>
		<span class="token comment">// previous dequeue, so try backing up.</span>
		d <span class="token operator">=</span> <span class="token function">loadPoolChainElt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>prev<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>popHead 只会被  producer调用,首先拿到头结点: ,如果头结点不为空,尝试调用 头结点(<code>poolDequeue</code>)的 <code>popHead()</code>.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token comment">// 自旋锁的模式,避免加锁.</span>
<span class="token comment">// </span>
<span class="token comment">// popHead removes and returns the element at the head of the queue.</span>
<span class="token comment">// It returns false if the queue is empty. It must only be called by a</span>
<span class="token comment">// single producer.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>poolDequeue<span class="token punctuation">)</span> <span class="token function">popHead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>any<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> slot <span class="token operator">*</span>eface
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		ptrs <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>headTail<span class="token punctuation">)</span>
		head<span class="token punctuation">,</span> tail <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span>ptrs<span class="token punctuation">)</span>
		<span class="token keyword">if</span> tail <span class="token operator">==</span> head <span class="token punctuation">&#123;</span>
			<span class="token comment">// Queue is empty.</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
		<span class="token punctuation">&#125;</span>

		<span class="token comment">// head 是队头的前一个位置,所以要后移一位.</span>
		<span class="token comment">// 在读出 slot 的 value 之前就将 head值 -1,取消对这个 slot 的控制.</span>
		<span class="token comment">// Confirm tail and decrement head. We do this before</span>
		<span class="token comment">// reading the value to take back ownership of this</span>
		<span class="token comment">// slot.</span>
		head<span class="token operator">--</span>
		ptrs2 <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">pack</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> tail<span class="token punctuation">)</span>
		<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>headTail<span class="token punctuation">,</span> ptrs<span class="token punctuation">,</span> ptrs2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// We successfully took back slot.</span>
			slot <span class="token operator">=</span> <span class="token operator">&amp;</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">[</span>head<span class="token operator">&amp;</span><span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	val <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>any<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> val <span class="token operator">==</span> <span class="token function">dequeueNil</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		val <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// Zero the slot. Unlike popTail, this isn't racing with</span>
	<span class="token comment">// pushHead, so we don't need to be careful here.</span>
	<span class="token operator">*</span>slot <span class="token operator">=</span> eface<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> val<span class="token punctuation">,</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>通过 自旋锁的模式(for 循环 + CAS)  避免加锁.</p>
<h4 id="2-1-3-getSlow"><a href="#2-1-3-getSlow" class="headerlink" title="2.1.3 getSlow"></a>2.1.3 getSlow</h4><p>如果在 shared里面没有获得缓存对象,则继续调用 <code>Pool.getSlow</code>, 尝试从其他 P 的 <code>poolLocal</code> 中偷取.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token function">getSlow</span><span class="token punctuation">(</span>pid <span class="token builtin">int</span><span class="token punctuation">)</span> any <span class="token punctuation">&#123;</span>
	<span class="token comment">// See the comment in pin regarding ordering of the loads.</span>
	size <span class="token operator">:=</span> <span class="token function">runtime_LoadAcquintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>localSize<span class="token punctuation">)</span> <span class="token comment">// load-acquire</span>
	locals <span class="token operator">:=</span> p<span class="token punctuation">.</span>local                            <span class="token comment">// load-consume</span>
	<span class="token comment">// 尝试从其他P中偷取 对象.</span>
	<span class="token comment">// Try to steal one element from other procs.</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">int</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		l <span class="token operator">:=</span> <span class="token function">indexLocal</span><span class="token punctuation">(</span>locals<span class="token punctuation">,</span> <span class="token punctuation">(</span>pid<span class="token operator">+</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token function">int</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> x<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> l<span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">popTail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> x <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> x
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 尝试从victim cache中取对象。这发生在尝试从其他 P 的 poolLocal 偷去失败后，</span>
	<span class="token comment">// 因为这样可以使 victim 中的对象更容易被回收.</span>
	<span class="token comment">// </span>
	<span class="token comment">// Try the victim cache. We do this after attempting to steal</span>
	<span class="token comment">// from all primary caches because we want objects in the</span>
	<span class="token comment">// victim cache to age out if at all possible.</span>
	size <span class="token operator">=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>victimSize<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span> <span class="token operator">>=</span> size <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	locals <span class="token operator">=</span> p<span class="token punctuation">.</span>victim
	l <span class="token operator">:=</span> <span class="token function">indexLocal</span><span class="token punctuation">(</span>locals<span class="token punctuation">,</span> pid<span class="token punctuation">)</span>
	<span class="token keyword">if</span> x <span class="token operator">:=</span> l<span class="token punctuation">.</span>private<span class="token punctuation">;</span> x <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		l<span class="token punctuation">.</span>private <span class="token operator">=</span> <span class="token boolean">nil</span>
		<span class="token keyword">return</span> x
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">int</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		l <span class="token operator">:=</span> <span class="token function">indexLocal</span><span class="token punctuation">(</span>locals<span class="token punctuation">,</span> <span class="token punctuation">(</span>pid<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">%</span><span class="token function">int</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> x<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> l<span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">popTail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> x <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> x
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 清空 victimCache,下次就不用从这里面找了.</span>
	<span class="token comment">// Mark the victim cache as empty for future gets don't bother</span>
	<span class="token comment">// with it.</span>
	atomic<span class="token punctuation">.</span><span class="token function">StoreUintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>victimSize<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>从索引为 pid + 1 的 poolLocal 开始, 尝试调用shared.popTail 获取缓存对象. 如果没有拿到,从victim中查找. 和 从 poolLocal 的逻辑类似.</li>
<li>最后 如果还没有找到,就把 victimSize 值 0. 防止后来的人再从 victim中找.</li>
<li>在 Get 函数的最后，经过这一番操作还是没找到缓存的对象，就调用 New 函数创建一个新的对象.</li>
</ol>
<h4 id="2-1-4-popTail"><a href="#2-1-4-popTail" class="headerlink" title="2.1.4 popTail"></a>2.1.4 popTail</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>poolChain<span class="token punctuation">)</span> <span class="token function">popTail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>any<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	d <span class="token operator">:=</span> <span class="token function">loadPoolChainElt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>tail<span class="token punctuation">)</span>
	<span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// It's important that we load the next pointer</span>
		<span class="token comment">// *before* popping the tail. In general, d may be</span>
		<span class="token comment">// transiently empty, but if next is non-nil before</span>
		<span class="token comment">// the pop and the pop fails, then d is permanently</span>
		<span class="token comment">// empty, which is the only condition under which it's</span>
		<span class="token comment">// safe to drop d from the chain.</span>
		d2 <span class="token operator">:=</span> <span class="token function">loadPoolChainElt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>next<span class="token punctuation">)</span>

		<span class="token keyword">if</span> val<span class="token punctuation">,</span> ok <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">popTail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> val<span class="token punctuation">,</span> ok
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> d2 <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// This is the only dequeue. It's empty right</span>
			<span class="token comment">// now, but could be pushed to in the future.</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
		<span class="token punctuation">&#125;</span>

		<span class="token comment">// The tail of the chain has been drained, so move on</span>
		<span class="token comment">// to the next dequeue. Try to drop it from the chain</span>
		<span class="token comment">// so the next pop doesn't have to look at the empty</span>
		<span class="token comment">// dequeue again.</span>
		<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapPointer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>tail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>d2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// We won the race. Clear the prev pointer so</span>
			<span class="token comment">// the garbage collector can collect the empty</span>
			<span class="token comment">// dequeue and so popHead doesn't back up</span>
			<span class="token comment">// further than necessary.</span>
			<span class="token comment">// 甩掉尾结点.</span>
			<span class="token function">storePoolChainElt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d2<span class="token punctuation">.</span>prev<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		d <span class="token operator">=</span> d2
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// popTail removes and returns the element at the tail of the queue.</span>
<span class="token comment">// It returns false if the queue is empty. It may be called by any</span>
<span class="token comment">// number of consumers.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>poolDequeue<span class="token punctuation">)</span> <span class="token function">popTail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>any<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> slot <span class="token operator">*</span>eface
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		ptrs <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>headTail<span class="token punctuation">)</span>
		head<span class="token punctuation">,</span> tail <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span>ptrs<span class="token punctuation">)</span>
		<span class="token keyword">if</span> tail <span class="token operator">==</span> head <span class="token punctuation">&#123;</span>
			<span class="token comment">// Queue is empty.</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
		<span class="token punctuation">&#125;</span>

		<span class="token comment">// Confirm head and tail (for our speculative check</span>
		<span class="token comment">// above) and increment tail. If this succeeds, then</span>
		<span class="token comment">// we own the slot at tail.</span>
		ptrs2 <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">pack</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> tail<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>headTail<span class="token punctuation">,</span> ptrs<span class="token punctuation">,</span> ptrs2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Success.</span>
			slot <span class="token operator">=</span> <span class="token operator">&amp;</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">[</span>tail<span class="token operator">&amp;</span><span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// We now own slot.</span>
	val <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>any<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> val <span class="token operator">==</span> <span class="token function">dequeueNil</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		val <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// Tell pushHead that we're done with this slot. Zeroing the</span>
	<span class="token comment">// slot is also important so we don't leave behind references</span>
	<span class="token comment">// that could keep this object live longer than necessary.</span>
	<span class="token comment">//</span>
	<span class="token comment">// We write to val first and then publish that we're done with</span>
	<span class="token comment">// this slot by atomically writing to typ.</span>
	slot<span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token boolean">nil</span>
	atomic<span class="token punctuation">.</span><span class="token function">StorePointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>slot<span class="token punctuation">.</span>typ<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token comment">// At this point pushHead owns the slot.</span>

	<span class="token keyword">return</span> val<span class="token punctuation">,</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h3 id="2-2-Put"><a href="#2-2-Put" class="headerlink" title="2.2. Put"></a>2.2. Put</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Put adds x to the pool.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token function">Put</span><span class="token punctuation">(</span>x any<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token function">fastrandn</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Randomly drop x on floor.</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
		race<span class="token punctuation">.</span><span class="token function">ReleaseMerge</span><span class="token punctuation">(</span><span class="token function">poolRaceAddr</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
		race<span class="token punctuation">.</span><span class="token function">Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	l<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">pin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> l<span class="token punctuation">.</span>private <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		l<span class="token punctuation">.</span>private <span class="token operator">=</span> x
		x <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> x <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		l<span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">pushHead</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">runtime_procUnpin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">&#123;</span>
		race<span class="token punctuation">.</span><span class="token function">Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<ol>
<li>先绑定 g 和 P.  然后尝试将 x 赋值给 private字段.</li>
<li>如果失败. 就调用 pushHead() 尝试将其放入 shared字段 维护的双端队列中.</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/majunmin/image/etcd/20220815204632.png"></p>
<h4 id="2-2-1-pushHead"><a href="#2-2-1-pushHead" class="headerlink" title="2.2.1 pushHead"></a>2.2.1 pushHead</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>poolChain<span class="token punctuation">)</span> <span class="token function">pushHead</span><span class="token punctuation">(</span>val any<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	d <span class="token operator">:=</span> c<span class="token punctuation">.</span>head
	<span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// Initialize the chain.</span>
		<span class="token keyword">const</span> initSize <span class="token operator">=</span> <span class="token number">8</span> <span class="token comment">// Must be a power of 2</span>
		d <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>poolChainElt<span class="token punctuation">)</span>
		d<span class="token punctuation">.</span>vals <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>eface<span class="token punctuation">,</span> initSize<span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>head <span class="token operator">=</span> d
		<span class="token function">storePoolChainElt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>tail<span class="token punctuation">,</span> d<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> d<span class="token punctuation">.</span><span class="token function">pushHead</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 当前 poolDequeue 满了. 分配一个 当前 poolDequeue 2倍的一个 poolDequeue</span>
	<span class="token comment">// The current dequeue is full. Allocate a new one of twice</span>
	<span class="token comment">// the size.</span>
	newSize <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span>
	<span class="token keyword">if</span> newSize <span class="token operator">>=</span> dequeueLimit <span class="token punctuation">&#123;</span>
		<span class="token comment">// Can't make it any bigger.</span>
		newSize <span class="token operator">=</span> dequeueLimit
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 收尾相连. 构成链表</span>
	d2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>poolChainElt<span class="token punctuation">&#123;</span>prev<span class="token punctuation">:</span> d<span class="token punctuation">&#125;</span>
	d2<span class="token punctuation">.</span>vals <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>eface<span class="token punctuation">,</span> newSize<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>head <span class="token operator">=</span> d2
	<span class="token function">storePoolChainElt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>next<span class="token punctuation">,</span> d2<span class="token punctuation">)</span>
	d2<span class="token punctuation">.</span><span class="token function">pushHead</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// // 将 val 添加到双端队列头部。如果队列已满，则返回 false。此函数只能被一个生产者调用</span>
<span class="token comment">//</span>
<span class="token comment">// pushHead adds val at the head of the queue. It returns false if the</span>
<span class="token comment">// queue is full. It must only be called by a single producer.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>poolDequeue<span class="token punctuation">)</span> <span class="token function">pushHead</span><span class="token punctuation">(</span>val any<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	ptrs <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>headTail<span class="token punctuation">)</span>
	head<span class="token punctuation">,</span> tail <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span>ptrs<span class="token punctuation">)</span>

	<span class="token comment">//队列满了</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>tail<span class="token operator">+</span><span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>dequeueBits<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> head <span class="token punctuation">&#123;</span>
		<span class="token comment">// Queue is full.</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">&#125;</span>
	slot <span class="token operator">:=</span> <span class="token operator">&amp;</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">[</span>head<span class="token operator">&amp;</span><span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

	<span class="token comment">// Check if the head slot has been released by popTail.</span>
	typ <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadPointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>slot<span class="token punctuation">.</span>typ<span class="token punctuation">)</span>
	<span class="token keyword">if</span> typ <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// Another goroutine is still cleaning up the tail, so</span>
		<span class="token comment">// the queue is actually still full.</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// The head slot is free, so we own it.</span>
	<span class="token keyword">if</span> val <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		val <span class="token operator">=</span> <span class="token function">dequeueNil</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>any<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> val

	<span class="token comment">// Increment head. This passes ownership of slot to popTail</span>
	<span class="token comment">// and acts as a store barrier for writing the slot.</span>
	atomic<span class="token punctuation">.</span><span class="token function">AddUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>headTail<span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span>dequeueBits<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="3-pack-amp-unpack"><a href="#3-pack-amp-unpack" class="headerlink" title="3. pack &amp; unpack"></a>3. pack &amp; unpack</h3><h2 id="3-GC"><a href="#3-GC" class="headerlink" title="3. GC"></a>3. GC</h2><hr>
<p>[参考]<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/qcrao-2018/p/12736031.html">深度解密 Go 语言之 sync.Pool </a><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzA4ODg0NDkzOA==&mid=2247487149&idx=1&sn=f38f2d72fd7112e19e97d5a2cd304430&source=41#wechat_redirect">请问sync.Pool有什么缺点?</a><br><a target="_blank" rel="noopener" href="https://xargin.com/lock-contention-in-go/">几个 Go 系统可能遇到的锁问题</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://majunmin.github.io/post/golang-sync-Pool%E8%A7%A3%E6%9E%90.html" data-id="clamitdfb002im9nrdqbcg3zr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/" rel="tag">golang</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-clickhouse-原理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/clickhouse-%E5%8E%9F%E7%90%86.html" class="article-date">
  <time datetime="2022-08-11T17:00:53.000Z" itemprop="datePublished">2022-08-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/clickhouse-%E5%8E%9F%E7%90%86.html">clickhouse-原理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>Clickhouse 是一个 用于联机分析(OLAP)的 列式存储数据库管理系统(DBMS).</p>
</blockquote>
        
          <p class="article-more-link">
            <a href="/post/clickhouse-%E5%8E%9F%E7%90%86.html#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://majunmin.github.io/post/clickhouse-%E5%8E%9F%E7%90%86.html" data-id="clamitdf70020m9nr0d8n1uop" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/clickhouse/" rel="tag">clickhouse</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-go-build-实现包切换" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/go-build-%E5%AE%9E%E7%8E%B0%E5%8C%85%E5%88%87%E6%8D%A2.html" class="article-date">
  <time datetime="2022-08-03T04:18:02.000Z" itemprop="datePublished">2022-08-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/go-build-%E5%AE%9E%E7%8E%B0%E5%8C%85%E5%88%87%E6%8D%A2.html">go build 实现包切换</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>参考 <a target="_blank" rel="noopener" href="https://github.com/gin-gonic/gin">Gin</a> 的实现</p>
<p>gin 在  <code>internal/json</code>包中实现了多个 json 包的序列化能力, 默认使用官方<code>encoding/json</code>包. 如何保证这些包不会冲突呢?</p>
<p>这里用到了  <code>go build -tags</code> 的能力.</p>
<p><code>[json.go](https://github.com/gin-gonic/gin/blob/master/internal/json/json.go)</code></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Copyright 2017 Bo-Yi Wu. All rights reserved.</span>
<span class="token comment">// Use of this source code is governed by a MIT style</span>
<span class="token comment">// license that can be found in the LICENSE file.</span>

<span class="token comment">//go:build !jsoniter &amp;&amp; !go_json &amp;&amp; !(sonic &amp;&amp; avx &amp;&amp; (linux || windows || darwin) &amp;&amp; amd64)</span>
<span class="token comment">// +build !jsoniter</span>
<span class="token comment">// +build !go_json</span>
<span class="token comment">// +build !sonic !avx !linux,!windows,!darwin !amd64</span>

<span class="token keyword">package</span> json

<span class="token keyword">import</span> <span class="token string">"encoding/json"</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	<span class="token comment">// Marshal is exported by gin/json package.</span>
	Marshal <span class="token operator">=</span> json<span class="token punctuation">.</span>Marshal
	<span class="token comment">// Unmarshal is exported by gin/json package.</span>
	Unmarshal <span class="token operator">=</span> json<span class="token punctuation">.</span>Unmarshal
	<span class="token comment">// MarshalIndent is exported by gin/json package.</span>
	MarshalIndent <span class="token operator">=</span> json<span class="token punctuation">.</span>MarshalIndent
	<span class="token comment">// NewDecoder is exported by gin/json package.</span>
	NewDecoder <span class="token operator">=</span> json<span class="token punctuation">.</span>NewDecoder
	<span class="token comment">// NewEncoder is exported by gin/json package.</span>
	NewEncoder <span class="token operator">=</span> json<span class="token punctuation">.</span>NewEncoder
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p><code>[jsoniter.go](https://github.com/gin-gonic/gin/blob/master/internal/json/jsoniter.go)</code></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Copyright 2017 Bo-Yi Wu. All rights reserved.</span>
<span class="token comment">// Use of this source code is governed by a MIT style</span>
<span class="token comment">// license that can be found in the LICENSE file.</span>

<span class="token comment">//go:build jsoniter</span>
<span class="token comment">// +build jsoniter</span>

<span class="token keyword">package</span> json

<span class="token keyword">import</span> jsoniter <span class="token string">"github.com/json-iterator/go"</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	json <span class="token operator">=</span> jsoniter<span class="token punctuation">.</span>ConfigCompatibleWithStandardLibrary
	<span class="token comment">// Marshal is exported by gin/json package.</span>
	Marshal <span class="token operator">=</span> json<span class="token punctuation">.</span>Marshal
	<span class="token comment">// Unmarshal is exported by gin/json package.</span>
	Unmarshal <span class="token operator">=</span> json<span class="token punctuation">.</span>Unmarshal
	<span class="token comment">// MarshalIndent is exported by gin/json package.</span>
	MarshalIndent <span class="token operator">=</span> json<span class="token punctuation">.</span>MarshalIndent
	<span class="token comment">// NewDecoder is exported by gin/json package.</span>
	NewDecoder <span class="token operator">=</span> json<span class="token punctuation">.</span>NewDecoder
	<span class="token comment">// NewEncoder is exported by gin/json package.</span>
	NewEncoder <span class="token operator">=</span> json<span class="token punctuation">.</span>NewEncoder
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h2 id="切换-不同的-json实现"><a href="#切换-不同的-json实现" class="headerlink" title="切换 不同的 json实现"></a>切换 不同的 json实现</h2><p>采用  jsoniter包</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">go build -tags&#x3D;jsoniter .<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h2 id="条件编译"><a href="#条件编译" class="headerlink" title="条件编译"></a>条件编译</h2><p>通过在代码中增加注释<code>//+build xxx</code>时,编译时传递对应的tags值,就会编译不同的文件.</p>
<ul>
<li>构建约束以一行<code>+build</code>开始的注释.在+build之后列出了一些条件,在这些条件成立时,该文件应包含在编译的包中;</li>
<li>约束可以出现在任何源文件中,不限于go文件;</li>
<li><code>+build</code>必须出现在package语句之前,+build注释之后应要有一个空行.</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>-<a target="_blank" rel="noopener" href="https://go.dev/doc/tutorial/compile-install">Compile and install the application</a><br>-<a target="_blank" rel="noopener" href="https://pkg.go.dev/cmd/go#hdr-Compile_packages_and_dependencies">Compile_packages_and_dependencies</a><br>-<a target="_blank" rel="noopener" href="https://zsy-cn.github.io/%E6%9D%A1%E4%BB%B6%E7%BC%96%E8%AF%91.html">Go条件编译</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://majunmin.github.io/post/go-build-%E5%AE%9E%E7%8E%B0%E5%8C%85%E5%88%87%E6%8D%A2.html" data-id="clamitdf90029m9nrb8wfbe2w" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/go/" rel="tag">go</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/go-build/" rel="tag">go build</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-洋葱架构" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/%E6%B4%8B%E8%91%B1%E6%9E%B6%E6%9E%84.html" class="article-date">
  <time datetime="2022-07-23T06:23:04.000Z" itemprop="datePublished">2022-07-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/%E6%B4%8B%E8%91%B1%E6%9E%B6%E6%9E%84.html">洋葱架构</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/./%E6%B4%8B%E8%91%B1%E6%9E%B6%E6%9E%84/%E6%B4%8B%E8%91%B1%E6%9E%B6%E6%9E%84.webp" alt="洋葱架构"></p>
        
          <p class="article-more-link">
            <a href="/post/%E6%B4%8B%E8%91%B1%E6%9E%B6%E6%9E%84.html#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://majunmin.github.io/post/%E6%B4%8B%E8%91%B1%E6%9E%B6%E6%9E%84.html" data-id="clamitdfj003tm9nrawou6yk7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%9E%B6%E6%9E%84/" rel="tag">架构</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-六边形架构" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/%E5%85%AD%E8%BE%B9%E5%BD%A2%E6%9E%B6%E6%9E%84.html" class="article-date">
  <time datetime="2022-07-23T02:47:02.000Z" itemprop="datePublished">2022-07-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/%E5%85%AD%E8%BE%B9%E5%BD%A2%E6%9E%B6%E6%9E%84.html">六边形架构</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>分层架构是一种架构风格,本质是避免耦合,使边界清晰.<br>六边形架构 遵循了分层架构的所有约束与特性，其实使用 端口与适配器这个名字更加合适.因为六边形架构的 边数没有意义.</p>
<p>六边形架构能够充分地区分 领域模型与 输入输出设备之间的界限.</p>
<p><img src="/./%E5%85%AD%E8%BE%B9%E5%BD%A2%E6%9E%B6%E6%9E%84/%E5%85%AD%E8%BE%B9%E5%BD%A2%E6%9E%B6%E6%9E%84.png" alt="六边形架构"></p>
        
          <p class="article-more-link">
            <a href="/post/%E5%85%AD%E8%BE%B9%E5%BD%A2%E6%9E%B6%E6%9E%84.html#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://majunmin.github.io/post/%E5%85%AD%E8%BE%B9%E5%BD%A2%E6%9E%B6%E6%9E%84.html" data-id="clamitdfg003cm9nr3y6hf5oh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%9E%B6%E6%9E%84/" rel="tag">架构</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-位运算-基础" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/%E4%BD%8D%E8%BF%90%E7%AE%97-%E5%9F%BA%E7%A1%80.html" class="article-date">
  <time datetime="2022-07-19T15:29:47.000Z" itemprop="datePublished">2022-07-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/%E4%BD%8D%E8%BF%90%E7%AE%97-%E5%9F%BA%E7%A1%80.html">位运算-基础</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <span id="more"></span>


<h2 id="异或操作"><a href="#异或操作" class="headerlink" title="异或操作"></a>异或操作</h2><pre class="line-numbers language-none"><code class="language-none">x ^ 0  &#x3D; x
x ^ 1s &#x3D; ~x  &#x2F;&#x2F; 1s  &#x3D; ~0
x ^ ~x &#x3D; 1s
x ^ x  &#x3D; 0
c &#x3D; a ^ b  &#x3D;&gt; a ^ c &#x3D; b,  b ^ c &#x3D; a    &#x2F;&#x2F; 交换两个数
a ^ b ^ c &#x3D; a ^ (b ^ c) &#x3D; (a ^ b) ^ c  &#x2F;&#x2F; associate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="指定位置的-位运算"><a href="#指定位置的-位运算" class="headerlink" title="指定位置的 位运算"></a>指定位置的 位运算</h2><ol>
<li>将 x 最右边的 n位清零  :   <code>x &amp; (~0 &lt;&lt; n)</code></li>
<li>获取 x 的第n位的值(1|0):   <code>(x &gt;&gt; n) &amp; 1</code></li>
<li>获取 x 的第n位的幂值   :    <code>x &amp;(1 &lt;&lt; n)</code></li>
<li>仅将第 n 位置 1       :    <code>x | (1&lt;&lt; n)</code></li>
<li>仅将第 n 位置 0       :    <code>x &amp; ~(1&lt;&lt; n)</code></li>
<li>仅将第 n 位取反       :    <code>x ^ (1&lt;&lt; n)</code></li>
<li>将x最高位至第n(含)位清零:    <code>x&amp;((1&lt;&lt;n) - 1)</code></li>
<li>获取x  最右边的 1     :     <code>x &amp; -x</code> (lowbit操作)</li>
</ol>
<ul>
<li>a      &#x3D; 00110100</li>
<li>~a     &#x3D; 11001011</li>
<li>-a     &#x3D; 11001100</li>
<li>a &amp; -a &#x3D; 00000100</li>
</ul>
<h2 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h2><ol>
<li>判断奇偶</li>
</ol>
<ul>
<li>x % 2 &#x3D;&#x3D; 0  &#x3D;&gt;   (x &amp; 1) &#x3D;&#x3D; 0</li>
<li>x % 2 &#x3D;&#x3D; 1  &#x3D;&gt;   (x &amp; 1) &#x3D;&#x3D; 1</li>
</ul>
<ol start="2">
<li><p>x &gt;&gt; 1 &#x3D;&#x3D; x &#x2F; 2<br>mid &#x3D; (left + right) &#x2F; 2   &#x3D;&#x3D; mid &#x3D; (left + right) &gt;&gt; 1 </p>
</li>
<li><p>x &#x3D; x &amp;(x-1)  清零最低位的1</p>
</li>
<li><p>x &amp; -x       得到最低位的 1 </p>
</li>
<li><p>x &amp; ~x  &#x3D;&#x3D; 0</p>
</li>
</ol>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><ul>
<li>bloomFilter</li>
<li></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://majunmin.github.io/post/%E4%BD%8D%E8%BF%90%E7%AE%97-%E5%9F%BA%E7%A1%80.html" data-id="clamitdfg003am9nrefi6e7uz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BD%8D%E8%BF%90%E7%AE%97/" rel="tag">位运算</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&amp;laquo; 上一页</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/">下一页 &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithm/">Algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata/">bigdata</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/golang/">golang</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jvm/">jvm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kafka/">kafka</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/kafka/consumer/">consumer</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/maven/">maven</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/%E9%94%81/">锁</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/test/">test</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tomcat/">tomcat</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Algorithm/" rel="tag">Algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ApplicationContext/" rel="tag">ApplicationContext</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BeanFactory/" rel="tag">BeanFactory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DNSResolver/" rel="tag">DNSResolver</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Intelij/" rel="tag">Intelij</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/" rel="tag">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aop/" rel="tag">aop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/apacheAB/" rel="tag">apacheAB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" rel="tag">bean生命周期</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bigcache/" rel="tag">bigcache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bigdata/" rel="tag">bigdata</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/" rel="tag">blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cache/" rel="tag">cache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/centos7/" rel="tag">centos7</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clickhouse/" rel="tag">clickhouse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/consumer/" rel="tag">consumer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/context/" rel="tag">context</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/convey/" rel="tag">convey</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-compose/" rel="tag">docker-compose</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/etcd/" rel="tag">etcd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fastcache/" rel="tag">fastcache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gateway/" rel="tag">gateway</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/" rel="tag">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go-build/" rel="tag">go build</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gomock/" rel="tag">gomock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gomonkey/" rel="tag">gomonkey</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grpc/" rel="tag">grpc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/idea/" rel="tag">idea</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/image/" rel="tag">image</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jstat/" rel="tag">jstat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jvm/" rel="tag">jvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafak/" rel="tag">kafak</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/" rel="tag">kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/" rel="tag">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/md/" rel="tag">md</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/producer/" rel="tag">producer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/" rel="tag">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springboot/" rel="tag">springboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/test/" rel="tag">test</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/" rel="tag">tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/trace/" rel="tag">trace</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BD%8D%E8%BF%90%E7%AE%97/" rel="tag">位运算</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" rel="tag">动态代理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8C%BA%E9%97%B4/" rel="tag">区间</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag">微服务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/" rel="tag">快捷键</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7/" rel="tag">性能测试工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9E%B6%E6%9E%84/" rel="tag">架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9E%B6%E6%9E%84%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93/" rel="tag">架构整洁之道</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9F%A5%E8%AF%A2%E8%AE%A1%E5%88%92/" rel="tag">查询计划</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" rel="tag">源码剖析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%B4%A2%E5%BC%95/" rel="tag">索引</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E6%AE%B5%E6%A0%91/" rel="tag">线段树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="tag">读书笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%86%E6%B3%A2%E5%85%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">逆波兰表达式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%94%81/" rel="tag">锁</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Algorithm/" style="font-size: 10px;">Algorithm</a> <a href="/tags/ApplicationContext/" style="font-size: 10px;">ApplicationContext</a> <a href="/tags/BeanFactory/" style="font-size: 10px;">BeanFactory</a> <a href="/tags/DNSResolver/" style="font-size: 10px;">DNSResolver</a> <a href="/tags/Intelij/" style="font-size: 10px;">Intelij</a> <a href="/tags/algorithm/" style="font-size: 10px;">algorithm</a> <a href="/tags/aop/" style="font-size: 10px;">aop</a> <a href="/tags/apacheAB/" style="font-size: 10px;">apacheAB</a> <a href="/tags/bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" style="font-size: 10px;">bean生命周期</a> <a href="/tags/bigcache/" style="font-size: 10px;">bigcache</a> <a href="/tags/bigdata/" style="font-size: 12.5px;">bigdata</a> <a href="/tags/blog/" style="font-size: 15px;">blog</a> <a href="/tags/cache/" style="font-size: 15px;">cache</a> <a href="/tags/centos7/" style="font-size: 10px;">centos7</a> <a href="/tags/clickhouse/" style="font-size: 10px;">clickhouse</a> <a href="/tags/consumer/" style="font-size: 10px;">consumer</a> <a href="/tags/context/" style="font-size: 12.5px;">context</a> <a href="/tags/convey/" style="font-size: 10px;">convey</a> <a href="/tags/docker/" style="font-size: 12.5px;">docker</a> <a href="/tags/docker-compose/" style="font-size: 10px;">docker-compose</a> <a href="/tags/etcd/" style="font-size: 10px;">etcd</a> <a href="/tags/fastcache/" style="font-size: 10px;">fastcache</a> <a href="/tags/gateway/" style="font-size: 10px;">gateway</a> <a href="/tags/go/" style="font-size: 12.5px;">go</a> <a href="/tags/go-build/" style="font-size: 10px;">go build</a> <a href="/tags/golang/" style="font-size: 20px;">golang</a> <a href="/tags/gomock/" style="font-size: 10px;">gomock</a> <a href="/tags/gomonkey/" style="font-size: 10px;">gomonkey</a> <a href="/tags/grpc/" style="font-size: 10px;">grpc</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/idea/" style="font-size: 10px;">idea</a> <a href="/tags/image/" style="font-size: 10px;">image</a> <a href="/tags/jstat/" style="font-size: 10px;">jstat</a> <a href="/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/tags/kafak/" style="font-size: 10px;">kafak</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/linux/" style="font-size: 12.5px;">linux</a> <a href="/tags/maven/" style="font-size: 12.5px;">maven</a> <a href="/tags/md/" style="font-size: 10px;">md</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/producer/" style="font-size: 10px;">producer</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/springboot/" style="font-size: 10px;">springboot</a> <a href="/tags/test/" style="font-size: 17.5px;">test</a> <a href="/tags/tomcat/" style="font-size: 10px;">tomcat</a> <a href="/tags/trace/" style="font-size: 10px;">trace</a> <a href="/tags/%E4%BD%8D%E8%BF%90%E7%AE%97/" style="font-size: 10px;">位运算</a> <a href="/tags/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" style="font-size: 10px;">动态代理</a> <a href="/tags/%E5%8C%BA%E9%97%B4/" style="font-size: 10px;">区间</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 10px;">并发</a> <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 12.5px;">微服务</a> <a href="/tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/" style="font-size: 10px;">快捷键</a> <a href="/tags/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">性能测试工具</a> <a href="/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 12.5px;">架构</a> <a href="/tags/%E6%9E%B6%E6%9E%84%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93/" style="font-size: 10px;">架构整洁之道</a> <a href="/tags/%E6%9F%A5%E8%AF%A2%E8%AE%A1%E5%88%92/" style="font-size: 10px;">查询计划</a> <a href="/tags/%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" style="font-size: 10px;">源码剖析</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 12.5px;">算法</a> <a href="/tags/%E7%B4%A2%E5%BC%95/" style="font-size: 10px;">索引</a> <a href="/tags/%E7%BA%BF%E6%AE%B5%E6%A0%91/" style="font-size: 10px;">线段树</a> <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">读书笔记</a> <a href="/tags/%E9%80%86%E6%B3%A2%E5%85%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 10px;">逆波兰表达式</a> <a href="/tags/%E9%94%81/" style="font-size: 10px;">锁</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">五月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">三月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/post/fastcache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html">fastcache源码分析</a>
          </li>
        
          <li>
            <a href="/post/%E5%A4%A7%E6%95%B0%E6%8D%AE-%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E5%A4%A7%E5%AE%BD%E8%A1%A8.html">大数据-数据仓库大宽表</a>
          </li>
        
          <li>
            <a href="/post/golang%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96.html">golang如何避免循环依赖</a>
          </li>
        
          <li>
            <a href="/post/Go-Test-Gomonkey%E4%BD%BF%E7%94%A8.html">Go-Test-Gomonkey使用</a>
          </li>
        
          <li>
            <a href="/post/Go-Test-Convey%E4%BD%BF%E7%94%A8.html">Go-Test-Convey使用</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 majm<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":120,"height":200,"position":"left","hOffset":20,"vOffset":50},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>