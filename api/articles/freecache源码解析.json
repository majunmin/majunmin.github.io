{"title":"freecache源码解析","uid":"33024321d4d721b36bc422db43cf754d","slug":"freecache源码解析","date":"2022-10-10T15:59:17.000Z","updated":"2022-10-10T17:01:20.789Z","comments":true,"path":"api/articles/freecache源码解析.json","keywords":null,"cover":[],"content":"<p><a href=\"https://github.com/coocood/freecache\">代码仓库地址</a></p>\n<p>freeCache 相比较  golang 的原生map实现缓存,可以<code>通过减少指针的数量避免 GC压力</code>,无论存储了多少数据,内部只会占用 512个指针,<br> 数据集 通过 hash(key) 被分片256个 <code>segment</code>,每个 <code>segment</code> 有两个指针,</p>\n<ul>\n<li>一个存储键和值的唤醒缓冲区</li>\n<li>另一个是用于查找索引条目的索引切片<br>每个 <code>segment</code> 都有自己的  <code>sync.Mutex</code>,所以支持多线程访问.</li>\n</ul>\n<span id=\"more\"></span>\n\n<p>[TOC]</p>\n<h2 id=\"特性\"><a href=\"#特性\" class=\"headerlink\" title=\"特性:\"></a>特性:</h2><ul>\n<li>存储百万的 entrys</li>\n<li>Zero GC overhead</li>\n<li>线程安全的并发访问</li>\n<li>纯Golang实现</li>\n<li>支持数据过期</li>\n<li>LRU缓存替换策略</li>\n<li>严格限制内存使用</li>\n<li>附带一个 demo server,支持 一些带有管道(pipeline)的 redis命令</li>\n<li>迭代支持</li>\n</ul>\n<h2 id=\"1-数据结构\"><a href=\"#1-数据结构\" class=\"headerlink\" title=\"1. 数据结构\"></a>1. 数据结构</h2><p><img src=\"/post/freecache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/freeCache-datastructure.png\" alt=\"datastructure\"></p>\n<p>将 缓存分为  256 个段 segment, 每个 segment 分为  256 个slot. 采用 开发寻址发 解决 hash冲突问题.</p>\n<ul>\n<li>每个segment 一把锁, 减小锁粒度</li>\n<li>每个 slot 存储数据的索引(在 ringBuffer中的偏移量)</li>\n<li>rinbBuffer 循环数组,实际存储数据.</li>\n</ul>\n<h3 id=\"Cache\"><a href=\"#Cache\" class=\"headerlink\" title=\"Cache\"></a>Cache</h3><pre class=\"line-numbers language-go\" data-language=\"go\"><code class=\"language-go\"><span class=\"token comment\">// Cache is a freecache instance.</span>\n<span class=\"token keyword\">type</span> Cache <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span>\n\tlocks    <span class=\"token punctuation\">[</span>segmentCount<span class=\"token punctuation\">]</span>sync<span class=\"token punctuation\">.</span>Mutex <span class=\"token comment\">// 减小锁粒度, 每个 segment 一把锁</span>\n\tsegments <span class=\"token punctuation\">[</span>segmentCount<span class=\"token punctuation\">]</span>segment\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"segment\"><a href=\"#segment\" class=\"headerlink\" title=\"segment\"></a>segment</h3><pre class=\"line-numbers language-go\" data-language=\"go\"><code class=\"language-go\"><span class=\"token comment\">// a segment contains 256 slots, a slot is an array of entry pointers ordered by hash16 value</span>\n<span class=\"token comment\">// the entry can be looked up by hash value of the key.</span>\n<span class=\"token keyword\">type</span> segment <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span>\n\trb    RingBuf <span class=\"token comment\">// ring buffer that stores data 环形缓冲区 存储数据</span>\n\tsegId <span class=\"token builtin\">int</span>\n\t<span class=\"token boolean\">_</span>     <span class=\"token builtin\">uint32</span>\n\n\t<span class=\"token comment\">// 一些 统计信息</span>\n\tmissCount     <span class=\"token builtin\">int64</span>\n\thitCount      <span class=\"token builtin\">int64</span>\n\tentryCount    <span class=\"token builtin\">int64</span>\n\ttotalCount    <span class=\"token builtin\">int64</span> <span class=\"token comment\">// number of entries in ring buffer, including deleted entries.</span>\n\ttotalTime     <span class=\"token builtin\">int64</span> <span class=\"token comment\">// used to calculate least recent used entry.</span>\n\ttotalEvacuate <span class=\"token builtin\">int64</span> <span class=\"token comment\">// used for debug</span>\n\ttotalExpired  <span class=\"token builtin\">int64</span> <span class=\"token comment\">// used for debug</span>\n\toverwrites    <span class=\"token builtin\">int64</span> <span class=\"token comment\">// used for debug</span>\n\ttouched       <span class=\"token builtin\">int64</span> <span class=\"token comment\">// used for debug</span>\n\n\ttimer     Timer      <span class=\"token comment\">// Timer giving current time 用于计算过期时间</span>\n\tvacuumLen <span class=\"token builtin\">int64</span>      <span class=\"token comment\">// up to vacuumLen, new data can be written without overwriting old data.</span>\n\tslotLens  <span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int32</span> <span class=\"token comment\">// The actual length for every slot.   - (每个 slot 容纳的 entryPtr  数量 len)</span>\n\tslotCap   <span class=\"token builtin\">int32</span>      <span class=\"token comment\">// max number of entry pointers a slot can hold. - (每个 slot 可以容纳的 entryPtr  cap)</span>\n\tslotsData <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>entryPtr <span class=\"token comment\">// shared by all 256 slots - (用来解决 hash冲突, 每个 slot 是一个 []entryPtr, 是直接寻址法)</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"Entry\"><a href=\"#Entry\" class=\"headerlink\" title=\"Entry\"></a>Entry</h3><pre class=\"line-numbers language-go\" data-language=\"go\"><code class=\"language-go\">\n<span class=\"token comment\">// entry pointer struct points to an entry in ring buffer, </span>\n<span class=\"token keyword\">type</span> entryPtr <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span>\n\toffset   <span class=\"token builtin\">int64</span>  <span class=\"token comment\">// entry offset in ring buffer</span>\n\thash16   <span class=\"token builtin\">uint16</span> <span class=\"token comment\">// entries are ordered by hash16 in a slot.</span>\n\tkeyLen   <span class=\"token builtin\">uint16</span> <span class=\"token comment\">// used to compare a key</span>\n\treserved <span class=\"token builtin\">uint32</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\">// entry header struct in ring buffer, followed by key and value.</span>\n<span class=\"token keyword\">type</span> entryHdr <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span>\n\taccessTime <span class=\"token builtin\">uint32</span>\n\texpireAt   <span class=\"token builtin\">uint32</span>\n\tkeyLen     <span class=\"token builtin\">uint16</span>\n\thash16     <span class=\"token builtin\">uint16</span>\n\tvalLen     <span class=\"token builtin\">uint32</span>\n\tvalCap     <span class=\"token builtin\">uint32</span>\n\tdeleted    <span class=\"token builtin\">bool</span>\n\tslotId     <span class=\"token builtin\">uint8</span>\n\treserved   <span class=\"token builtin\">uint16</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><code>entryPtr</code>: slot 中存储的数据结构<br><code>entryHdr</code>: ringBuffer 中存储的 entry 的  Header 结构</p>\n<p>每个slot 中存储的 <code>entryPtr</code>. entryPtr.offset 指向 entry 在  ringBuffer 中的偏移量.</p>\n<p>ringBuffer 中 entry的数据结构<br><a href=\"./freecache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/ringBuffer-%3Eentry.png\"></a></p>\n<h3 id=\"ringBuffer\"><a href=\"#ringBuffer\" class=\"headerlink\" title=\"ringBuffer\"></a>ringBuffer</h3><p>ringBuffer 固定大小, 当超过 容量时, 新数据会覆盖老数据.<br> 数据 存储在 data[begin] -&gt; data[end] 之间.</p>\n<pre class=\"line-numbers language-go\" data-language=\"go\"><code class=\"language-go\"><span class=\"token comment\">// Ring buffer has a fixed size, when data exceeds the</span>\n<span class=\"token comment\">// size, old data will be overwritten by new data.</span>\n<span class=\"token comment\">// It only contains the data in the stream from begin to end</span>\n<span class=\"token keyword\">type</span> RingBuf <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span>\n\tbegin <span class=\"token builtin\">int64</span> <span class=\"token comment\">// beginning offset of the data stream.</span>\n\tend   <span class=\"token builtin\">int64</span> <span class=\"token comment\">// ending offset of the data stream.</span>\n\tdata  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span>\n\tindex <span class=\"token builtin\">int</span> <span class=\"token comment\">//range from '0' to 'len(rb.data)-1'</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h2 id=\"2-常用操作\"><a href=\"#2-常用操作\" class=\"headerlink\" title=\"2. 常用操作:\"></a>2. 常用操作:</h2><pre class=\"line-numbers language-sh\" data-language=\"sh\"><code class=\"language-sh\"># go doc freecache Cache\n\npackage freecache &#x2F;&#x2F; import &quot;github.com&#x2F;coocood&#x2F;freecache&quot;\n\ntype Cache struct &#123;\n        &#x2F;&#x2F; Has unexported fields.\n&#125;\n    Cache is a freecache instance.\n\nfunc NewCache(size int) (cache *Cache)\nfunc NewCacheCustomTimer(size int, timer Timer) (cache *Cache)\nfunc (cache *Cache) AverageAccessTime() int64\nfunc (cache *Cache) Clear()\nfunc (cache *Cache) Del(key []byte) (affected bool)\nfunc (cache *Cache) DelInt(key int64) (affected bool)\nfunc (cache *Cache) EntryCount() (entryCount int64)\nfunc (cache *Cache) EvacuateCount() (count int64)\nfunc (cache *Cache) ExpiredCount() (count int64)\nfunc (cache *Cache) Get(key []byte) (value []byte, err error)\nfunc (cache *Cache) GetFn(key []byte, fn func([]byte) error) (err error)\nfunc (cache *Cache) GetInt(key int64) (value []byte, err error)\nfunc (cache *Cache) GetIntWithExpiration(key int64) (value []byte, expireAt uint32, err error)\nfunc (cache *Cache) GetOrSet(key, value []byte, expireSeconds int) (retValue []byte, err error)\nfunc (cache *Cache) GetWithBuf(key, buf []byte) (value []byte, err error)\nfunc (cache *Cache) GetWithExpiration(key []byte) (value []byte, expireAt uint32, err error)\nfunc (cache *Cache) HitCount() (count int64)\nfunc (cache *Cache) HitRate() float64\nfunc (cache *Cache) LookupCount() int64\nfunc (cache *Cache) MissCount() (count int64)\nfunc (cache *Cache) NewIterator() *Iterator\nfunc (cache *Cache) OverwriteCount() (overwriteCount int64)\nfunc (cache *Cache) Peek(key []byte) (value []byte, err error)\nfunc (cache *Cache) PeekFn(key []byte, fn func([]byte) error) (err error)\nfunc (cache *Cache) ResetStatistics()\nfunc (cache *Cache) Set(key, value []byte, expireSeconds int) (err error)\nfunc (cache *Cache) SetAndGet(key, value []byte, expireSeconds int) (retValue []byte, found bool, err error)\nfunc (cache *Cache) SetInt(key int64, value []byte, expireSeconds int) (err error)\nfunc (cache *Cache) TTL(key []byte) (timeLeft uint32, err error)\nfunc (cache *Cache) Touch(key []byte, expireSeconds int) (err error)\nfunc (cache *Cache) TouchedCount() (touchedCount int64)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n<h3 id=\"1-Set\"><a href=\"#1-Set\" class=\"headerlink\" title=\"1. Set\"></a>1. Set</h3><pre class=\"line-numbers language-go\" data-language=\"go\"><code class=\"language-go\"><span class=\"token comment\">// Set sets a key, value and expiration for a cache entry and stores it in the cache.</span>\n<span class=\"token comment\">// If the key is larger than 65535 or value is larger than 1/1024 of the cache size,</span>\n<span class=\"token comment\">// the entry will not be written to the cache. expireSeconds &lt;= 0 means no expire,</span>\n<span class=\"token comment\">// but it can be evicted when cache is full.</span>\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>cache <span class=\"token operator\">*</span>Cache<span class=\"token punctuation\">)</span> <span class=\"token function\">Set</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> value <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">,</span> expireSeconds <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>err <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\thashVal <span class=\"token operator\">:=</span> <span class=\"token function\">hashFunc</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n\tsegID <span class=\"token operator\">:=</span> hashVal <span class=\"token operator\">&amp;</span> segmentAndOpVal <span class=\"token comment\">// 通过 位运算 计算取余操作</span>\n\tcache<span class=\"token punctuation\">.</span>locks<span class=\"token punctuation\">[</span>segID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\terr <span class=\"token operator\">=</span> cache<span class=\"token punctuation\">.</span>segments<span class=\"token punctuation\">[</span>segID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> hashVal<span class=\"token punctuation\">,</span> expireSeconds<span class=\"token punctuation\">)</span>\n\tcache<span class=\"token punctuation\">.</span>locks<span class=\"token punctuation\">[</span>segID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\"># 取余操作. 对于 2的幂次方取余 可以通过位运算的方式进行处理:\nx % 256 &#x3D; x &amp; (2^8 -1)\nx % 512 &#x3D; x &amp; (2^9 -1)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>拿到 segment 后, </p>\n<pre class=\"line-numbers language-go\" data-language=\"go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>seg <span class=\"token operator\">*</span>segment<span class=\"token punctuation\">)</span> <span class=\"token function\">set</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> value <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">,</span> hashVal <span class=\"token builtin\">uint64</span><span class=\"token punctuation\">,</span> expireSeconds <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>err <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token comment\">// param check</span>\n\t<span class=\"token operator\">...</span>\n\t\n\tnow <span class=\"token operator\">:=</span> seg<span class=\"token punctuation\">.</span>timer<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\texpireAt <span class=\"token operator\">:=</span> <span class=\"token function\">uint32</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> expireSeconds <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span>\n\t\texpireAt <span class=\"token operator\">=</span> now <span class=\"token operator\">+</span> <span class=\"token function\">uint32</span><span class=\"token punctuation\">(</span>expireSeconds<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\n\t<span class=\"token comment\">// uint64     32     16      8       8</span>\n\t<span class=\"token comment\">// hashValue          hash16 slotId</span>\n\tslotId <span class=\"token operator\">:=</span> <span class=\"token function\">uint8</span><span class=\"token punctuation\">(</span>hashVal <span class=\"token operator\">>></span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span>\n\thash16 <span class=\"token operator\">:=</span> <span class=\"token function\">uint16</span><span class=\"token punctuation\">(</span>hashVal <span class=\"token operator\">>></span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\n\n\t<span class=\"token comment\">// slot 中每个元素是按照  hash16 升序排序的, 因此查询操作可以利用二分查找</span>\n\t<span class=\"token comment\">//从 segment 中查找数据</span>\n\tslot <span class=\"token operator\">:=</span> seg<span class=\"token punctuation\">.</span><span class=\"token function\">getSlot</span><span class=\"token punctuation\">(</span>slotId<span class=\"token punctuation\">)</span>\n\tidx<span class=\"token punctuation\">,</span> match <span class=\"token operator\">:=</span> seg<span class=\"token punctuation\">.</span><span class=\"token function\">lookup</span><span class=\"token punctuation\">(</span>slot<span class=\"token punctuation\">,</span> hash16<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span> <span class=\"token comment\">// idx 要插入的位置,  match 是否找到  对应的 entry</span>\n\n\t<span class=\"token keyword\">var</span> hdrBuf <span class=\"token punctuation\">[</span>ENTRY_HDR_SIZE<span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span>\n\thdr <span class=\"token operator\">:=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>entryHdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>unsafe<span class=\"token punctuation\">.</span><span class=\"token function\">Pointer</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>hdrBuf<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token comment\">// 进行替换操作</span>\n\t<span class=\"token keyword\">if</span> match <span class=\"token punctuation\">&#123;</span>\n\t\tmatchedPtr <span class=\"token operator\">:=</span> <span class=\"token operator\">&amp;</span>slot<span class=\"token punctuation\">[</span>idx<span class=\"token punctuation\">]</span>\n\t\tseg<span class=\"token punctuation\">.</span>rb<span class=\"token punctuation\">.</span><span class=\"token function\">ReadAt</span><span class=\"token punctuation\">(</span>hdrBuf<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> matchedPtr<span class=\"token punctuation\">.</span>offset<span class=\"token punctuation\">)</span>\n\t\thdr<span class=\"token punctuation\">.</span>slotId <span class=\"token operator\">=</span> slotId\n\t\thdr<span class=\"token punctuation\">.</span>hash16 <span class=\"token operator\">=</span> hash16\n\t\thdr<span class=\"token punctuation\">.</span>keyLen <span class=\"token operator\">=</span> <span class=\"token function\">uint16</span><span class=\"token punctuation\">(</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\toriginAccessTime <span class=\"token operator\">:=</span> hdr<span class=\"token punctuation\">.</span>accessTime\n\t\thdr<span class=\"token punctuation\">.</span>accessTime <span class=\"token operator\">=</span> now\n\t\thdr<span class=\"token punctuation\">.</span>expireAt <span class=\"token operator\">=</span> expireAt\n\t\thdr<span class=\"token punctuation\">.</span>valLen <span class=\"token operator\">=</span> <span class=\"token function\">uint32</span><span class=\"token punctuation\">(</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">if</span> hdr<span class=\"token punctuation\">.</span>valCap <span class=\"token operator\">>=</span> hdr<span class=\"token punctuation\">.</span>valLen <span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token comment\">//in place overwrite</span>\n\t\t\tatomic<span class=\"token punctuation\">.</span><span class=\"token function\">AddInt64</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>seg<span class=\"token punctuation\">.</span>totalTime<span class=\"token punctuation\">,</span> <span class=\"token function\">int64</span><span class=\"token punctuation\">(</span>hdr<span class=\"token punctuation\">.</span>accessTime<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token function\">int64</span><span class=\"token punctuation\">(</span>originAccessTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\tseg<span class=\"token punctuation\">.</span>rb<span class=\"token punctuation\">.</span><span class=\"token function\">WriteAt</span><span class=\"token punctuation\">(</span>hdrBuf<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> matchedPtr<span class=\"token punctuation\">.</span>offset<span class=\"token punctuation\">)</span>\n\t\t\tseg<span class=\"token punctuation\">.</span>rb<span class=\"token punctuation\">.</span><span class=\"token function\">WriteAt</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> matchedPtr<span class=\"token punctuation\">.</span>offset<span class=\"token operator\">+</span>ENTRY_HDR_SIZE<span class=\"token operator\">+</span><span class=\"token function\">int64</span><span class=\"token punctuation\">(</span>hdr<span class=\"token punctuation\">.</span>keyLen<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\tatomic<span class=\"token punctuation\">.</span><span class=\"token function\">AddInt64</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>seg<span class=\"token punctuation\">.</span>overwrites<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">return</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t\t<span class=\"token comment\">// avoid unnecessary memory copy.</span>\n\t\tseg<span class=\"token punctuation\">.</span><span class=\"token function\">delEntryPtr</span><span class=\"token punctuation\">(</span>slotId<span class=\"token punctuation\">,</span> slot<span class=\"token punctuation\">,</span> idx<span class=\"token punctuation\">)</span>\n\t\tmatch <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n\t\t<span class=\"token comment\">// increase capacity and limit entry len.</span>\n\t\t<span class=\"token comment\">// 进行扩容</span>\n\t\t<span class=\"token keyword\">for</span> hdr<span class=\"token punctuation\">.</span>valCap <span class=\"token operator\">&lt;</span> hdr<span class=\"token punctuation\">.</span>valLen <span class=\"token punctuation\">&#123;</span>\n\t\t\thdr<span class=\"token punctuation\">.</span>valCap <span class=\"token operator\">*=</span> <span class=\"token number\">2</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t\t<span class=\"token keyword\">if</span> hdr<span class=\"token punctuation\">.</span>valCap <span class=\"token operator\">></span> <span class=\"token function\">uint32</span><span class=\"token punctuation\">(</span>maxKeyValLen<span class=\"token operator\">-</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\thdr<span class=\"token punctuation\">.</span>valCap <span class=\"token operator\">=</span> <span class=\"token function\">uint32</span><span class=\"token punctuation\">(</span>maxKeyValLen <span class=\"token operator\">-</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n\t\thdr<span class=\"token punctuation\">.</span>slotId <span class=\"token operator\">=</span> slotId\n\t\thdr<span class=\"token punctuation\">.</span>hash16 <span class=\"token operator\">=</span> hash16\n\t\thdr<span class=\"token punctuation\">.</span>keyLen <span class=\"token operator\">=</span> <span class=\"token function\">uint16</span><span class=\"token punctuation\">(</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\thdr<span class=\"token punctuation\">.</span>accessTime <span class=\"token operator\">=</span> now\n\t\thdr<span class=\"token punctuation\">.</span>expireAt <span class=\"token operator\">=</span> expireAt\n\t\thdr<span class=\"token punctuation\">.</span>valLen <span class=\"token operator\">=</span> <span class=\"token function\">uint32</span><span class=\"token punctuation\">(</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\thdr<span class=\"token punctuation\">.</span>valCap <span class=\"token operator\">=</span> <span class=\"token function\">uint32</span><span class=\"token punctuation\">(</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">if</span> hdr<span class=\"token punctuation\">.</span>valCap <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">// avoid infinite loop when increasing capacity.</span>\n\t\t\thdr<span class=\"token punctuation\">.</span>valCap <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\n\tentryLen <span class=\"token operator\">:=</span> ENTRY_HDR_SIZE <span class=\"token operator\">+</span> <span class=\"token function\">int64</span><span class=\"token punctuation\">(</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">int64</span><span class=\"token punctuation\">(</span>hdr<span class=\"token punctuation\">.</span>valCap<span class=\"token punctuation\">)</span>\n\tslotModified <span class=\"token operator\">:=</span> seg<span class=\"token punctuation\">.</span><span class=\"token function\">evacuate</span><span class=\"token punctuation\">(</span>entryLen<span class=\"token punctuation\">,</span> slotId<span class=\"token punctuation\">,</span> now<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> slotModified <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token comment\">// the slot has been modified during evacuation, we need to looked up for the 'idx' again.</span>\n\t\t<span class=\"token comment\">// otherwise there would be index out of bound error.</span>\n\t\tslot <span class=\"token operator\">=</span> seg<span class=\"token punctuation\">.</span><span class=\"token function\">getSlot</span><span class=\"token punctuation\">(</span>slotId<span class=\"token punctuation\">)</span>\n\t\tidx<span class=\"token punctuation\">,</span> match <span class=\"token operator\">=</span> seg<span class=\"token punctuation\">.</span><span class=\"token function\">lookup</span><span class=\"token punctuation\">(</span>slot<span class=\"token punctuation\">,</span> hash16<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token comment\">// assert(match == false)</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\tnewOff <span class=\"token operator\">:=</span> seg<span class=\"token punctuation\">.</span>rb<span class=\"token punctuation\">.</span><span class=\"token function\">End</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token comment\">// 将 偏移量(data在 ringbuffer 中的偏移量)写入  slot</span>\n\tseg<span class=\"token punctuation\">.</span><span class=\"token function\">insertEntryPtr</span><span class=\"token punctuation\">(</span>slotId<span class=\"token punctuation\">,</span> hash16<span class=\"token punctuation\">,</span> newOff<span class=\"token punctuation\">,</span> idx<span class=\"token punctuation\">,</span> hdr<span class=\"token punctuation\">.</span>keyLen<span class=\"token punctuation\">)</span>\n\t<span class=\"token comment\">// 写入 ringBuffer</span>\n\t<span class=\"token operator\">...</span>\n\t<span class=\"token keyword\">return</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n<ol>\n<li>通过 hash(key) 找到对应的 segment</li>\n<li>通过 hash(key) 找到对应的 slot<ul>\n<li>slotId :&#x3D; uint8(hashVal &gt;&gt; 8)</li>\n<li>hash16 :&#x3D; uint16(hashVal &gt;&gt; 16)</li>\n</ul>\n</li>\n<li>找到  kv 在 slot 中要插入的 位置.   idx</li>\n</ol>\n<ul>\n<li>如果对应的 key 存在,就进行替换. (如果 该位置的容量 &lt; 要插入的kv, 就将该位置标记为 deleted, 往后面append)</li>\n<li>如果 对应的key不存在,就在 slot 后面进行 append.(如果 空间不足就扩容)</li>\n</ul>\n<p>总结:<br>set 操作为什么高效?</p>\n<ul>\n<li>通过  hash(key) 计算  bucket 使用 位运算操作</li>\n<li>通过 二分查找 的方式 在 slot中查询 entry</li>\n<li>key 不存在的场景: <ul>\n<li>如果 ringBuffer容量充足, 就直接在 环尾部 append entry. 时间复杂度 是 O(1)</li>\n<li>如果 ringBuffer容量不足,需要将一些 key 移除掉. freeCache 通过一定的措施，保证移除key的操作时间复杂度为 O(1). entry追加操作的时间复杂度也是O(1)</li>\n</ul>\n</li>\n<li>key存在的场景(match) 找到entry索引:<ul>\n<li>如果原来预留的entry容量充足.那么直接更新原来的entryHdr 和 value. 时间复杂度是 O(1)</li>\n<li>如果原来预留的entry容量不足: freecache 为了避免底层移动数组数据. 不直接对原来的entry进行扩容,而是将原来的entry标记为删除(懒删除).然后在环形缓冲区默认append 新的entry. 时间复杂度是 O(1).</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"2-Get\"><a href=\"#2-Get\" class=\"headerlink\" title=\"2. Get\"></a>2. Get</h3><pre class=\"line-numbers language-go\" data-language=\"go\"><code class=\"language-go\"><span class=\"token operator\">/</span> Get returns the value or not found <span class=\"token builtin\">error</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>cache <span class=\"token operator\">*</span>Cache<span class=\"token punctuation\">)</span> <span class=\"token function\">Get</span><span class=\"token punctuation\">(</span>key <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>value <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">,</span> err <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\thashVal <span class=\"token operator\">:=</span> <span class=\"token function\">hashFunc</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>\n\tsegID <span class=\"token operator\">:=</span> hashVal <span class=\"token operator\">&amp;</span> segmentAndOpVal\n\tcache<span class=\"token punctuation\">.</span>locks<span class=\"token punctuation\">[</span>segID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\tvalue<span class=\"token punctuation\">,</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> cache<span class=\"token punctuation\">.</span>segments<span class=\"token punctuation\">[</span>segID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">,</span> hashVal<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n\tcache<span class=\"token punctuation\">.</span>locks<span class=\"token punctuation\">[</span>segID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span>\n<span class=\"token punctuation\">&#125;</span>\n\n\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>seg <span class=\"token operator\">*</span>segment<span class=\"token punctuation\">)</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> buf <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">,</span> hashVal <span class=\"token builtin\">uint64</span><span class=\"token punctuation\">,</span> peek <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>value <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">,</span> expireAt <span class=\"token builtin\">uint32</span><span class=\"token punctuation\">,</span> err <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\thdr<span class=\"token punctuation\">,</span> ptr<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> seg<span class=\"token punctuation\">.</span><span class=\"token function\">locate</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> hashVal<span class=\"token punctuation\">,</span> peek<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">return</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\texpireAt <span class=\"token operator\">=</span> hdr<span class=\"token punctuation\">.</span>expireAt\n\t<span class=\"token keyword\">if</span> <span class=\"token function\">cap</span><span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token function\">int</span><span class=\"token punctuation\">(</span>hdr<span class=\"token punctuation\">.</span>valLen<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\tvalue <span class=\"token operator\">=</span> buf<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span>hdr<span class=\"token punctuation\">.</span>valLen<span class=\"token punctuation\">]</span>\n\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n\t\tvalue <span class=\"token operator\">=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">,</span> hdr<span class=\"token punctuation\">.</span>valLen<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\n\tseg<span class=\"token punctuation\">.</span>rb<span class=\"token punctuation\">.</span><span class=\"token function\">ReadAt</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">,</span> ptr<span class=\"token punctuation\">.</span>offset<span class=\"token operator\">+</span>ENTRY_HDR_SIZE<span class=\"token operator\">+</span><span class=\"token function\">int64</span><span class=\"token punctuation\">(</span>hdr<span class=\"token punctuation\">.</span>keyLen<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>peek <span class=\"token punctuation\">&#123;</span>\n\t\tatomic<span class=\"token punctuation\">.</span><span class=\"token function\">AddInt64</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>seg<span class=\"token punctuation\">.</span>hitCount<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token keyword\">return</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ol>\n<li>找到  segment, 然后 找到 对应的 slot</li>\n<li><code>seg.locate()</code> 找到 对应的 <code>entryPtr</code>,以及 对应的 <code>entryHdr</code></li>\n</ol>\n<p>要读取的数据在 ringBuffer中的偏移量是   ptr.offset + ENTRY_HDR_SIZR + keyLen</p>\n<h3 id=\"3-过期-与删除\"><a href=\"#3-过期-与删除\" class=\"headerlink\" title=\"3. 过期 与删除\"></a>3. 过期 与删除</h3><h4 id=\"3-1-key-过期\"><a href=\"#3-1-key-过期\" class=\"headerlink\" title=\"3.1. key 过期\"></a>3.1. key 过期</h4><p>对于过期的数据,freecache会让它继续存储在RingBuf中,RingBuf从一开始初始化之后,就固定不变了. 是否删掉数据,对RingBuf的实际占用空间不会产生影响.<br>当get到一个过期缓存时，freecache会删掉缓存的entry索引(但是不会将缓存从RingBuf中移除), 然后对外报ErrNotFound错误. 当RingBuf的容量不足时,会从环头开始遍历,如果key已经过期，这时才会将它删除掉. 如果一个key已经过期时,在它被freecache删除之前,如果又重新set进来（过期不会主动删除entry索引，理论上有被重新set的可能），过期的entry容量充足的情况下，则会重新复用这个entry.<br>freecache这种过期机制,一方面减少了维护过期数据的工作,另一方面,freecache底层存储是采用数组来实现,要求缓存数据必须连续,缓存过期的剔除会带来空间碎片,挪动数组来维持缓存数据的连续性不是一个很好的选择.</p>\n<h4 id=\"3-2-key-删除\"><a href=\"#3-2-key-删除\" class=\"headerlink\" title=\"3.2 key 删除\"></a>3.2 key 删除</h4><p>freecache有一下两种情况会进行删除key操作:</p>\n<ul>\n<li>外部主动调用del接口删除key.</li>\n<li>set缓存时，发现key已经存在，但是为entry预留的cap不足时，会选择将旧的数据删掉，然后再环尾追加新的数据.</li>\n</ul>\n<p>freecache的删除机制也是<strong>懒删除</strong>,删除缓存时，只会删掉entry索引,但是缓存还是会继续保留在RingBuf中,只是被标记为删除,等到RingBuf容量不足需要置换缓存时,才会对标记为删除的缓存数据做最后的删除工作. freecache删除一个key,需要搜索entry索引和标记缓存数据.</p>\n<h2 id=\"4-RingBuffer\"><a href=\"#4-RingBuffer\" class=\"headerlink\" title=\"4. RingBuffer\"></a>4. RingBuffer</h2><pre class=\"line-numbers language-sh\" data-language=\"sh\"><code class=\"language-sh\">&#x2F;&#x2F; go doc RingBuf\npackage freecache &#x2F;&#x2F; import &quot;.&quot;\n\ntype RingBuf struct &#123;\n        &#x2F;&#x2F; Has unexported fields.\n&#125;\n    Ring buffer has a fixed size, when data exceeds the size, old data will be\n    overwritten by new data. It only contains the data in the stream from begin\n    to end\n\nfunc NewRingBuf(size int, begin int64) (rb RingBuf)\nfunc (rb *RingBuf) Begin() int64\nfunc (rb *RingBuf) Dump() []byte\nfunc (rb *RingBuf) End() int64\nfunc (rb *RingBuf) EqualAt(p []byte, off int64) bool\nfunc (rb *RingBuf) Evacuate(off int64, length int) (newOff int64)\nfunc (rb *RingBuf) ReadAt(p []byte, off int64) (n int, err error)\nfunc (rb *RingBuf) Reset(begin int64)\nfunc (rb *RingBuf) Resize(newSize int)\nfunc (rb *RingBuf) Size() int64\nfunc (rb *RingBuf) Skip(length int64)\nfunc (rb *RingBuf) Slice(off, length int64) ([]byte, error)\nfunc (rb *RingBuf) String() string\nfunc (rb *RingBuf) Write(p []byte) (n int, err error)\nfunc (rb *RingBuf) WriteAt(p []byte, off int64) (n int, err error)\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n<p><a href=\"https://ferrous-systems.com/blog/lock-free-ring-buffer/\">实现一个 ringBuffer</a></p>\n<hr>\n<p><a href=\"https://xiazemin.github.io/MyBlog/golang/2021/07/02/freecache.html\">freeCache zeroGC 的Go Cache</a><br><a href=\"https://github.com/majunmin/freecache/tree/reader\">添加注释的代码</a></p>\n","text":"代码仓库地址 freeCache 相比较 golang 的原生map实现缓存,可以通过减少指针的数量避免 GC压力,无论存储了多少数据,内部只会占用 512个指针, 数据集 通过 hash(key) 被分片256个 segment,每个 segment 有两个指针, 一个存储键和...","link":"","photos":[],"count_time":{"symbolsCount":"12k","symbolsTime":"11 mins."},"categories":[],"tags":[{"name":"golang","slug":"golang","count":9,"path":"api/tags/golang.json"},{"name":"cache","slug":"cache","count":3,"path":"api/tags/cache.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%89%B9%E6%80%A7\"><span class=\"toc-text\">特性:</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#1-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84\"><span class=\"toc-text\">1. 数据结构</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Cache\"><span class=\"toc-text\">Cache</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#segment\"><span class=\"toc-text\">segment</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Entry\"><span class=\"toc-text\">Entry</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#ringBuffer\"><span class=\"toc-text\">ringBuffer</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#2-%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C\"><span class=\"toc-text\">2. 常用操作:</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-Set\"><span class=\"toc-text\">1. Set</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-Get\"><span class=\"toc-text\">2. Get</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-%E8%BF%87%E6%9C%9F-%E4%B8%8E%E5%88%A0%E9%99%A4\"><span class=\"toc-text\">3. 过期 与删除</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3-1-key-%E8%BF%87%E6%9C%9F\"><span class=\"toc-text\">3.1. key 过期</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3-2-key-%E5%88%A0%E9%99%A4\"><span class=\"toc-text\">3.2 key 删除</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#4-RingBuffer\"><span class=\"toc-text\">4. RingBuffer</span></a></li></ol>","author":{"name":"majm","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"技术分享","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Go-Test-gomock使用","uid":"301b2e78436f0e9c40fa9a9acf52a404","slug":"Go-Test-gomock使用","date":"2022-11-14T11:53:38.000Z","updated":"2022-11-14T11:53:38.199Z","comments":true,"path":"api/articles/Go-Test-gomock使用.json","keywords":null,"cover":null,"text":"写出可测试 的代码 至关重要. 可以保证代码的稳定性. 帮助程序员减少bug. gomock 是一个go官方的模拟框架.gomock的使用场景: IO类型的数据, 本地文件,数据库,网络API,RPC等 依赖的服务还没有开发好, 这时候可以自己模拟一个服务, 加快开发进度提升开发...","link":"","photos":[],"count_time":{"symbolsCount":"2.7k","symbolsTime":"2 mins."},"categories":[{"name":"golang","slug":"golang","count":4,"path":"api/categories/golang.json"}],"tags":[{"name":"golang","slug":"golang","count":9,"path":"api/tags/golang.json"},{"name":"test","slug":"test","count":4,"path":"api/tags/test.json"},{"name":"gomock","slug":"gomock","count":1,"path":"api/tags/gomock.json"}],"author":{"name":"majm","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"技术分享","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"bigcache源码解析","uid":"411297e7dedff7a6e68a4f8255b55a82","slug":"bigcache源码解析","date":"2022-10-10T15:58:44.000Z","updated":"2022-10-10T17:02:41.761Z","comments":true,"path":"api/articles/bigcache源码解析.json","keywords":null,"cover":[],"text":"[TOC] Bigcache 的特点:并发支持,快速, 过期大量条目而不影响性能.bigcache将 缓存条目放在了堆上,节省了GC. 为了实现这一点. 需要对字节切片进行操作. 因此涉及到缓存条目的序列化与反序列化. bigcache, freecache 和 map 的基准测...","link":"","photos":[],"count_time":{"symbolsCount":"13k","symbolsTime":"12 mins."},"categories":[],"tags":[{"name":"golang","slug":"golang","count":9,"path":"api/tags/golang.json"},{"name":"cache","slug":"cache","count":3,"path":"api/tags/cache.json"},{"name":"bigcache","slug":"bigcache","count":1,"path":"api/tags/bigcache.json"}],"author":{"name":"majm","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"技术分享","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}