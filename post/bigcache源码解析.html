<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"majunmin.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="[TOC] Bigcache 的特点:并发支持,快速, 过期大量条目而不影响性能.bigcache将 缓存条目放在了堆上,节省了GC. 为了实现这一点. 需要对字节切片进行操作. 因此涉及到缓存条目的序列化与反序列化. bigcache, freecache 和 map 的基准测试">
<meta property="og:type" content="article">
<meta property="og:title" content="bigcache源码解析">
<meta property="og:url" content="https://majunmin.github.io/post/bigcache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html">
<meta property="og:site_name" content="majm的博客">
<meta property="og:description" content="[TOC] Bigcache 的特点:并发支持,快速, 过期大量条目而不影响性能.bigcache将 缓存条目放在了堆上,节省了GC. 为了实现这一点. 需要对字节切片进行操作. 因此涉及到缓存条目的序列化与反序列化. bigcache, freecache 和 map 的基准测试">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://majunmin.github.io/post/bigcache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/bigcache%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png">
<meta property="og:image" content="https://majunmin.github.io/post/bigcache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/bigcache-entry.png">
<meta property="og:image" content="https://majunmin.github.io/post/bigcache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/bigcache-entry.png">
<meta property="article:published_time" content="2022-10-10T15:58:44.000Z">
<meta property="article:modified_time" content="2022-10-10T17:02:41.761Z">
<meta property="article:author" content="majm">
<meta property="article:tag" content="golang">
<meta property="article:tag" content="cache">
<meta property="article:tag" content="bigcache">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://majunmin.github.io/post/bigcache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/bigcache%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png">

<link rel="canonical" href="https://majunmin.github.io/post/bigcache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>bigcache源码解析 | majm的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="majm的博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">majm的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://majunmin.github.io/post/bigcache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="majm">
      <meta itemprop="description" content="做一些简单的笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="majm的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          bigcache源码解析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-10-10 23:58:44" itemprop="dateCreated datePublished" datetime="2022-10-10T23:58:44+08:00">2022-10-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-10-11 01:02:41" itemprop="dateModified" datetime="2022-10-11T01:02:41+08:00">2022-10-11</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>9 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>[TOC]</p>
<h2 id="Bigcache-的特点"><a href="#Bigcache-的特点" class="headerlink" title="Bigcache 的特点:"></a>Bigcache 的特点:</h2><p>并发支持,快速, 过期大量条目而不影响性能.<br>bigcache将 缓存条目放在了堆上,节省了GC. 为了实现这一点. 需要对字节切片进行操作. 因此涉及到缓存条目的序列化与反序列化.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/allegro/bigcache-bench">bigcache, freecache 和 map 的基准测试</a></p>
<span id="more"></span>


<h2 id="内存使用情况"><a href="#内存使用情况" class="headerlink" title="内存使用情况"></a>内存使用情况</h2><p>可能会遇到,系统内存指数增长. 属于预期内行为. Go 运行时 以 跨度(span)为单位分配内存,并在不需要他们是将状态修改为 <code>free</code> 来通知操作系统.在操作系统需要重新调整地址用途之前. 跨度将保留为进程资源的一部分.</p>
<h2 id="怎么做到的高性能"><a href="#怎么做到的高性能" class="headerlink" title="怎么做到的高性能?"></a>怎么做到的高性能?</h2><p>BigCache依赖于 go1.5中做出的优化.<a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/9477">issue9477</a>: <code>对于key value 中没有指针的map,GC将忽略其内容.</code>因此 bigCache 中使用 <code>map[uint64]uint32</code>, key 为 hash(key). value 是 item的 偏移量.</p>
<p>item 保存在字节切片中,目的是为了 再次忽略  GC. 字节切片大小可以增长到 MB 而不影响性能, 因为 GC只能看到指向他们的 单个 指针. </p>
<h2 id="如何解决-hash-冲突-Hash-Collisions"><a href="#如何解决-hash-冲突-Hash-Collisions" class="headerlink" title="如何解决 hash 冲突(Hash Collisions)?"></a>如何解决 hash 冲突(Hash Collisions)?</h2><p>Bigcache 不解决 hash 冲突. 当一个新的item 与老 item  hash(key)相同. 新 item 会覆盖老item.</p>
<h2 id="Bigcache-Vs-freecche"><a href="#Bigcache-Vs-freecche" class="headerlink" title="Bigcache Vs freecche"></a>Bigcache Vs freecche</h2><p>两种缓存都提供了相同的功能. 但是他们是以不同的方式 减少 GC开销. bigCache 一依赖 <code>map[uint64]uint32</code>, freecache 实现了自己的基于切片的映射 来减少指针数量.</p>
<p><code>Bigcache</code> 相对于  <code>freecache</code> 的优势之一是: 不需要提前知道  缓存大小,因为 <code>Bigcache</code> 已满时,可以为新item 重新分配额外的内存. 而不是像 <code>freecache</code> 那样覆盖现有的.但是 <code>Bigcache</code> 也提供了参数 <code>HardMaxCacheSize</code> 设置缓存最大大小.</p>
<h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h2><h3 id="1-一些概念"><a href="#1-一些概念" class="headerlink" title="1. 一些概念"></a>1. 一些概念</h3><h4 id="1-shard"><a href="#1-shard" class="headerlink" title="1. shard"></a>1. shard</h4><p>分片,  用于 减少锁粒度 ,增加并发度.  cache 默认 有 1024 个分片. (需要时  2^n,  快速进行 hash计算)<br>shards 初始化以后是 不可以扩容的.</p>
<h4 id="2-CleanWindow"><a href="#2-CleanWindow" class="headerlink" title="2. CleanWindow"></a>2. CleanWindow</h4><p>删除过期entry 的  时间间隔(interval).<br>默认配置为 1s. 如果设置为  &lt; 1s, 可能会适得其反.</p>
<h4 id="3-lifeWindow"><a href="#3-lifeWindow" class="headerlink" title="3. lifeWindow"></a>3. lifeWindow</h4><p>entry 的过期时间. </p>
<blockquote>
<p>bigcache 的一个feature: 不支持为 特定的entry 单独设置  过期时间. </p>
</blockquote>
<h3 id="2-数据结构"><a href="#2-数据结构" class="headerlink" title="2. 数据结构"></a>2. 数据结构</h3><p><img src="/post/bigcache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/bigcache%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png"></p>
<h4 id="1-cache"><a href="#1-cache" class="headerlink" title="1. cache"></a>1. cache</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token comment">// BigCache is fast, concurrent, evicting cache created to keep big number of entries without impact on performance.</span>
<span class="token comment">// It keeps entries on heap but omits GC for them. To achieve that, operations take place on byte arrays,</span>
<span class="token comment">// therefore entries (de)serialization in front of the cache will be needed in most use cases.</span>
<span class="token keyword">type</span> BigCache <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	shards     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>cacheShard <span class="token comment">// shard分片 减小锁粒度,长度为 2^N</span>
	lifeWindow <span class="token builtin">uint64</span>
	clock      clock <span class="token comment">// 时钟,计算过期时间 会用到</span>
	hash       Hasher <span class="token comment">// hash 算法 分 shard</span>
	config     Config
	shardMask  <span class="token builtin">uint64</span> <span class="token comment">// 2^N-1</span>
	<span class="token builtin">close</span>      <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="2-shard"><a href="#2-shard" class="headerlink" title="2. shard"></a>2. shard</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token keyword">type</span> cacheShard <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	hashmap     <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint64</span><span class="token punctuation">]</span><span class="token builtin">uint32</span> <span class="token comment">//存储索引 key: hashKey  value: value存入  byteQueue的 offset</span>
	entries     queue<span class="token punctuation">.</span>BytesQueue  <span class="token comment">// 存储实际的数据 的 环形字节数组</span>
	lock        sync<span class="token punctuation">.</span>RWMutex      <span class="token comment">// 锁</span>
	entryBuffer <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>            <span class="token comment">//</span>
	onRemove    onRemoveCallback  <span class="token comment">// 回调函数, 有多种实现方式</span>

	isVerbose    <span class="token builtin">bool</span>
	statsEnabled <span class="token builtin">bool</span>
	logger       Logger
	clock        clock
	lifeWindow   <span class="token builtin">uint64</span>

	hashmapStats <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint64</span><span class="token punctuation">]</span><span class="token builtin">uint32</span> <span class="token comment">// 记录 key的 requestCount</span>
	stats        Stats             <span class="token comment">// shard 的 缓存 统计状态</span>
	cleanEnabled <span class="token builtin">bool</span>              <span class="token comment">// 是否开启 清理</span>
<span class="token punctuation">&#125;</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-entry"><a href="#3-entry" class="headerlink" title="3. entry"></a>3. entry</h4><p><img src="/post/bigcache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/bigcache-entry.png"></p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; EntryInfo holds informations about entry in the cache
type EntryInfo struct &#123;
	timestamp uint64
	hash      uint64
	key       string
	value     []byte
	err       error
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>timestamp: 8byte.<br>Hash:      8byte.<br>keyLen:    2byte.<br>key:       Nbyte.<br>value:     Nbyte.<br>&#x2F;&#x2F; headerSize(timestamp + hash + keyLen)  &#x3D; 18byte</p>
<p>将 kv 包装成 entry.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// header                | kv</span>
<span class="token comment">// timestamp|hash|keySize|key|value</span>
<span class="token keyword">func</span> <span class="token function">wrapEntry</span><span class="token punctuation">(</span>timestamp <span class="token builtin">uint64</span><span class="token punctuation">,</span> hash <span class="token builtin">uint64</span><span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> entry <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> buffer <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">&#123;</span>
	keyLength <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	blobLength <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token operator">+</span> headersSizeInBytes <span class="token operator">+</span> keyLength

	<span class="token comment">// 如果 blob 长度 > buffer,重新申请一个  buffer</span>
	<span class="token keyword">if</span> blobLength <span class="token operator">></span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token operator">*</span>buffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> blobLength<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	blob <span class="token operator">:=</span> <span class="token operator">*</span>buffer

	binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">PutUint64</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span>
	binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">PutUint64</span><span class="token punctuation">(</span>blob<span class="token punctuation">[</span>timestampSizeInBytes<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
	binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">PutUint16</span><span class="token punctuation">(</span>blob<span class="token punctuation">[</span>timestampSizeInBytes<span class="token operator">+</span>hashSizeInBytes<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">uint16</span><span class="token punctuation">(</span>keyLength<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>blob<span class="token punctuation">[</span>headersSizeInBytes<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>blob<span class="token punctuation">[</span>headersSizeInBytes<span class="token operator">+</span>keyLength<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span>

	<span class="token keyword">return</span> blob<span class="token punctuation">[</span><span class="token punctuation">:</span>blobLength<span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>解析 entry 为 kv 结构:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 读取 value:  array[headersSizeInBytes + keyLen:]</span>
<span class="token keyword">func</span> <span class="token function">readEntry</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 读取 keyLen</span>
	length <span class="token operator">:=</span> binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">Uint16</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>timestampSizeInBytes<span class="token operator">+</span>hashSizeInBytes<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

	<span class="token comment">// copy on read</span>
	dst <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">int</span><span class="token punctuation">(</span>headersSizeInBytes<span class="token operator">+</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> data<span class="token punctuation">[</span>headersSizeInBytes<span class="token operator">+</span>length<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> dst
<span class="token punctuation">&#125;</span>

<span class="token comment">// 读取 timestamp:  uint64(array)</span>
<span class="token keyword">func</span> <span class="token function">readTimestampFromEntry</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 读取 key:  array[headerSize:headerSize + keyLen]</span>
<span class="token keyword">func</span> <span class="token function">readKeyFromEntry</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
	length <span class="token operator">:=</span> binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">Uint16</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>timestampSizeInBytes<span class="token operator">+</span>hashSizeInBytes<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

	<span class="token comment">// copy on read</span>
	dst <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> data<span class="token punctuation">[</span>headersSizeInBytes<span class="token punctuation">:</span>headersSizeInBytes<span class="token operator">+</span>length<span class="token punctuation">]</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token function">bytesToString</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// compare key and entry.</span>
<span class="token keyword">func</span> <span class="token function">compareKeyFromEntry</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	length <span class="token operator">:=</span> binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">Uint16</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>timestampSizeInBytes<span class="token operator">+</span>hashSizeInBytes<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token function">bytesToString</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>headersSizeInBytes<span class="token punctuation">:</span>headersSizeInBytes<span class="token operator">+</span>length<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> key
<span class="token punctuation">&#125;</span>

<span class="token comment">//  读取 hash:  uint64(array[timestampSizeinByte:])</span>
<span class="token keyword">func</span> <span class="token function">readHashFromEntry</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>timestampSizeInBytes<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="4-byteQueue"><a href="#4-byteQueue" class="headerlink" title="4. byteQueue"></a>4. byteQueue</h4><p>实际存储数据.</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> BytesQueue <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	full         <span class="token builtin">bool</span>
	array        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
	capacity     <span class="token builtin">int</span>
	maxCapacity  <span class="token builtin">int</span>
	head         <span class="token builtin">int</span>
	tail         <span class="token builtin">int</span>
	count        <span class="token builtin">int</span>
	rightMargin  <span class="token builtin">int</span>
	headerBuffer <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
	verbose      <span class="token builtin">bool</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一个  kv 结构 是一个 <code>entry</code>. <code>entry</code> 存储在 array 里面.   通过 offset 来进行访问.</p>
<h3 id="3-常用方法"><a href="#3-常用方法" class="headerlink" title="3. 常用方法"></a>3. 常用方法</h3><h4 id="3-1-缓存初始化"><a href="#3-1-缓存初始化" class="headerlink" title="3.1  缓存初始化"></a>3.1  缓存初始化</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// NewBigCache initialize new instance of BigCache</span>
<span class="token keyword">func</span> <span class="token function">NewBigCache</span><span class="token punctuation">(</span>config Config<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>BigCache<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token function">newBigCache</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token operator">&amp;</span>systemClock<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">newBigCache</span><span class="token punctuation">(</span>config Config<span class="token punctuation">,</span> clock clock<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>BigCache<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// param check</span>
	<span class="token keyword">if</span> config<span class="token punctuation">.</span>Hasher <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		config<span class="token punctuation">.</span>Hasher <span class="token operator">=</span> <span class="token function">newDefaultHasher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	cache <span class="token operator">:=</span> <span class="token operator">&amp;</span>BigCache<span class="token punctuation">&#123;</span>
		shards<span class="token punctuation">:</span>     <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>cacheShard<span class="token punctuation">,</span> config<span class="token punctuation">.</span>Shards<span class="token punctuation">)</span><span class="token punctuation">,</span>
		lifeWindow<span class="token punctuation">:</span> <span class="token function">uint64</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>LifeWindow<span class="token punctuation">.</span><span class="token function">Seconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		clock<span class="token punctuation">:</span>      clock<span class="token punctuation">,</span>
		hash<span class="token punctuation">:</span>       config<span class="token punctuation">.</span>Hasher<span class="token punctuation">,</span>
		config<span class="token punctuation">:</span>     config<span class="token punctuation">,</span>
		shardMask<span class="token punctuation">:</span>  <span class="token function">uint64</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Shards <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 用于 快速计算 hash 值</span>
		<span class="token builtin">close</span><span class="token punctuation">:</span>      <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// 接收 close 信号的 一个 chan, 关闭主动清理任务</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 设置 onremove 回调函数</span>
	<span class="token keyword">var</span> onRemove <span class="token keyword">func</span><span class="token punctuation">(</span>wrappedEntry <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> reason RemoveReason<span class="token punctuation">)</span>
	<span class="token keyword">if</span> config<span class="token punctuation">.</span>OnRemoveWithMetadata <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		onRemove <span class="token operator">=</span> cache<span class="token punctuation">.</span>providedOnRemoveWithMetadata
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> config<span class="token punctuation">.</span>OnRemove <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		onRemove <span class="token operator">=</span> cache<span class="token punctuation">.</span>providedOnRemove
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> config<span class="token punctuation">.</span>OnRemoveWithReason <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		onRemove <span class="token operator">=</span> cache<span class="token punctuation">.</span>providedOnRemoveWithReason
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		onRemove <span class="token operator">=</span> cache<span class="token punctuation">.</span>notProvidedOnRemove
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 逐个初始化  shard</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> config<span class="token punctuation">.</span>Shards<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		cache<span class="token punctuation">.</span>shards<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">initNewShard</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> onRemove<span class="token punctuation">,</span> clock<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// 主动清理  过期数据</span>
	<span class="token keyword">if</span> config<span class="token punctuation">.</span>CleanWindow <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>CleanWindow<span class="token punctuation">)</span>
			<span class="token keyword">defer</span> ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">case</span> t <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
					cache<span class="token punctuation">.</span><span class="token function">cleanUp</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 进行过期数据清理</span>
				<span class="token keyword">case</span> <span class="token operator">&lt;-</span>cache<span class="token punctuation">.</span><span class="token builtin">close</span><span class="token punctuation">:</span>
					<span class="token keyword">return</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> cache<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h4 id="3-2-Get"><a href="#3-2-Get" class="headerlink" title="3.2 Get"></a>3.2 Get</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Get reads entry for the key.</span>
<span class="token comment">// It returns an ErrEntryNotFound when</span>
<span class="token comment">// no entry exists for the given key.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BigCache<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	hashedKey <span class="token operator">:=</span> c<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">Sum64</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	shard <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">getShard</span><span class="token punctuation">(</span>hashedKey<span class="token punctuation">)</span> <span class="token comment">// 取余操作,    c.shards[hashedKey&amp;c.shardMask]</span>
	<span class="token keyword">return</span> shard<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> hashedKey<span class="token punctuation">)</span> <span class="token comment">// 调用 shard.get 获取  value</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>bigcache.hash 默认使用  fnv hash算法.  <code>new 64-bit FNV-1a Hasher</code> 算法 可以 0 内存申请.</p>
<p><code>shard.Get</code></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>cacheShard<span class="token punctuation">)</span> <span class="token function">get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> hashedKey <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 加 读锁, 保护   hashmap</span>
	s<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	wrappedEntry<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">getWrappedEntry</span><span class="token punctuation">(</span>hashedKey<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		s<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// 判断 key 是否相同. 当发生hash冲突时,如果 key不相同, 直接返回 ErrEntryNotFound</span>
	<span class="token comment">// bigcache 不解决 hash Collision</span>
	<span class="token keyword">if</span> entryKey <span class="token operator">:=</span> <span class="token function">readKeyFromEntry</span><span class="token punctuation">(</span>wrappedEntry<span class="token punctuation">)</span><span class="token punctuation">;</span> key <span class="token operator">!=</span> entryKey <span class="token punctuation">&#123;</span>
		s<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		s<span class="token punctuation">.</span><span class="token function">collision</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> s<span class="token punctuation">.</span>isVerbose <span class="token punctuation">&#123;</span>
			s<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Collision detected. Both %q and %q have the same hash %x"</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> entryKey<span class="token punctuation">,</span> hashedKey<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token comment">// 如果  key 不存在, 返回  `ErrEntryNotFound`</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrEntryNotFound
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// entry: value的 字节数组</span>
	entry <span class="token operator">:=</span> <span class="token function">readEntry</span><span class="token punctuation">(</span>wrappedEntry<span class="token punctuation">)</span>
	s<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	s<span class="token punctuation">.</span><span class="token function">hit</span><span class="token punctuation">(</span>hashedKey<span class="token punctuation">)</span>

	<span class="token keyword">return</span> entry<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<h4 id="3-3-Set"><a href="#3-3-Set" class="headerlink" title="3.3 Set"></a>3.3 Set</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token comment">// Set saves entry under the key</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BigCache<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> entry <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	hashedKey <span class="token operator">:=</span> c<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">Sum64</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token comment">// 计算 hash 值</span>
	shard <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">getShard</span><span class="token punctuation">(</span>hashedKey<span class="token punctuation">)</span> <span class="token comment">// 根据  取余 计算 分片 </span>
	<span class="token keyword">return</span> shard<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> hashedKey<span class="token punctuation">,</span> entry<span class="token punctuation">)</span> <span class="token comment">//</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>shard ：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>cacheShard<span class="token punctuation">)</span> <span class="token function">set</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> hashedKey <span class="token builtin">uint64</span><span class="token punctuation">,</span> entry <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	currentTimestamp <span class="token operator">:=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>clock<span class="token punctuation">.</span><span class="token function">Epoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	s<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// hash Collision| key 已存在(并未进行更新), 将原来的 entry 软删除</span>
	<span class="token keyword">if</span> previousIndex <span class="token operator">:=</span> s<span class="token punctuation">.</span>hashmap<span class="token punctuation">[</span>hashedKey<span class="token punctuation">]</span><span class="token punctuation">;</span> previousIndex <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> previousEntry<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>entries<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>previousIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token function">resetKeyFromEntry</span><span class="token punctuation">(</span>previousEntry<span class="token punctuation">)</span>
			<span class="token comment">//remove hashkey</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>hashmap<span class="token punctuation">,</span> hashedKey<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

    <span class="token comment">// 如果 未开启  定时 清理任务, 那么 主动调用, 将最早的数据 清理(如果过期)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>s<span class="token punctuation">.</span>cleanEnabled <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> oldestEntry<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>entries<span class="token punctuation">.</span><span class="token function">Peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			s<span class="token punctuation">.</span><span class="token function">onEvict</span><span class="token punctuation">(</span>oldestEntry<span class="token punctuation">,</span> currentTimestamp<span class="token punctuation">,</span> s<span class="token punctuation">.</span>removeOldestEntry<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

    <span class="token comment">// 将kv 封装成  entry. ( 从这个方法里面可以 看出 entry 的 数据结构.)</span>
	w <span class="token operator">:=</span> <span class="token function">wrapEntry</span><span class="token punctuation">(</span>currentTimestamp<span class="token punctuation">,</span> hashedKey<span class="token punctuation">,</span> key<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">.</span>entryBuffer<span class="token punctuation">)</span>

	<span class="token comment">//  循环目的是为了 保证 一定放入 数据成功.</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// 放入  entrys 中  (bytesQueue)</span>
		<span class="token keyword">if</span> index<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>entries<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Push() 也可以看一下</span>
			s<span class="token punctuation">.</span>hashmap<span class="token punctuation">[</span>hashedKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">uint32</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
			s<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
		<span class="token comment">// 如果 放入 失败, (空间不足, 那么 就用 LRU算法, 清理出空间)</span>
		<span class="token keyword">if</span> s<span class="token punctuation">.</span><span class="token function">removeOldestEntry</span><span class="token punctuation">(</span>NoSpace<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			s<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"entry is bigger than max shard size"</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<blockquote>
<p><code>bigcache</code> 为何不提供更新的操作? 其实这是显而易见的:</p>
<p>每次插入元素, bigCache 会根据插入的 key 和 value 在 BytesQueue 中申请一个固定大小的空间. 因为无法保证更新的 value 值和旧的 value 长度相同(这也是数据定长存储的劣势),这样对 bigcache &gt; 来说，按照时间顺序的 <code>head</code> 和 <code>tail</code> 索引值会乱掉,所以干脆就不提供更新接口了.</p>
</blockquote>
<h5 id="wrapEntry"><a href="#wrapEntry" class="headerlink" title="wrapEntry"></a>wrapEntry</h5><pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token comment">// header                | kv</span>
<span class="token comment">// timestamp|hash|keySize|key|value</span>
<span class="token keyword">func</span> <span class="token function">wrapEntry</span><span class="token punctuation">(</span>timestamp <span class="token builtin">uint64</span><span class="token punctuation">,</span> hash <span class="token builtin">uint64</span><span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> entry <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> buffer <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">&#123;</span>
	keyLength <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	blobLength <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token operator">+</span> headersSizeInBytes <span class="token operator">+</span> keyLength

	<span class="token comment">// 如果 blob 长度 > buffer,重新申请一个  buffer</span>
	<span class="token keyword">if</span> blobLength <span class="token operator">></span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token operator">*</span>buffer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> blobLength<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	blob <span class="token operator">:=</span> <span class="token operator">*</span>buffer

	binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">PutUint64</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span>
	binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">PutUint64</span><span class="token punctuation">(</span>blob<span class="token punctuation">[</span>timestampSizeInBytes<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
	binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">PutUint16</span><span class="token punctuation">(</span>blob<span class="token punctuation">[</span>timestampSizeInBytes<span class="token operator">+</span>hashSizeInBytes<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">uint16</span><span class="token punctuation">(</span>keyLength<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>blob<span class="token punctuation">[</span>headersSizeInBytes<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>blob<span class="token punctuation">[</span>headersSizeInBytes<span class="token operator">+</span>keyLength<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span>

	<span class="token keyword">return</span> blob<span class="token punctuation">[</span><span class="token punctuation">:</span>blobLength<span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h4 id="3-4-Delete"><a href="#3-4-Delete" class="headerlink" title="3.4 Delete"></a>3.4 Delete</h4><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Delete removes the key</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>BigCache<span class="token punctuation">)</span> <span class="token function">Delete</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	hashedKey <span class="token operator">:=</span> c<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">Sum64</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	shard <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">getShard</span><span class="token punctuation">(</span>hashedKey<span class="token punctuation">)</span>
	<span class="token keyword">return</span> shard<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span>hashedKey<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>shard.del()</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">
<span class="token comment">// Optimistic 乐观锁机制</span>
<span class="token comment">// 主动删除, 将 entry 中 hash值 置为 0， 如果 不存在,直接返回, 不用加写锁</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>cacheShard<span class="token punctuation">)</span> <span class="token function">del</span><span class="token punctuation">(</span>hashedKey <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// Optimistic pre-check using only readlock</span>
	s<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		itemIndex <span class="token operator">:=</span> s<span class="token punctuation">.</span>hashmap<span class="token punctuation">[</span>hashedKey<span class="token punctuation">]</span>

		<span class="token keyword">if</span> itemIndex <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			s<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			s<span class="token punctuation">.</span><span class="token function">delmiss</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> ErrEntryNotFound
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>entries<span class="token punctuation">.</span><span class="token function">CheckGet</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>itemIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			s<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			s<span class="token punctuation">.</span><span class="token function">delmiss</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	s<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	s<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
		<span class="token comment">// After obtaining the writelock, we need to read the same again,</span>
		<span class="token comment">// since the data delivered earlier may be stale now</span>
		itemIndex <span class="token operator">:=</span> s<span class="token punctuation">.</span>hashmap<span class="token punctuation">[</span>hashedKey<span class="token punctuation">]</span>

		<span class="token keyword">if</span> itemIndex <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			s<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			s<span class="token punctuation">.</span><span class="token function">delmiss</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> ErrEntryNotFound
		<span class="token punctuation">&#125;</span>

		wrappedEntry<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>entries<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>itemIndex<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			s<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			s<span class="token punctuation">.</span><span class="token function">delmiss</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>

		<span class="token function">delete</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>hashmap<span class="token punctuation">,</span> hashedKey<span class="token punctuation">)</span>
		s<span class="token punctuation">.</span><span class="token function">onRemove</span><span class="token punctuation">(</span>wrappedEntry<span class="token punctuation">,</span> Deleted<span class="token punctuation">)</span>
		<span class="token keyword">if</span> s<span class="token punctuation">.</span>statsEnabled <span class="token punctuation">&#123;</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>hashmapStats<span class="token punctuation">,</span> hashedKey<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token comment">// 将 entry 中的 hash值 置为0,表示删除. (并不是立即回收空间)</span>
		<span class="token function">resetKeyFromEntry</span><span class="token punctuation">(</span>wrappedEntry<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	s<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	s<span class="token punctuation">.</span><span class="token function">delhit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<h3 id="4-BytesQueue"><a href="#4-BytesQueue" class="headerlink" title="4. BytesQueue"></a>4. BytesQueue</h3><p><a target="_blank" rel="noopener" href="https://github.com/allegro/bigcache/blob/master/queue/bytes_queue.go">BytesQueue</a> 是一个循环数组, 存储 entry 数据. 通过 offset 来进行访问. 减少 GC 开销. (shard 中的 hashmap 存储的是  hash(key) 与 offset 的映射关系).</p>
<p><img src="/post/bigcache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/bigcache-entry.png"></p>
<p>bytesQueue 的几个特点: </p>
<ol>
<li>存储的 entry  不会是  截断的. (一部分数据在tail, 一部分数据在  头部.)</li>
<li>entry 的数据格式:   如上图所示.</li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// go doc queue BytesQueue</span>
<span class="token keyword">package</span> queue <span class="token comment">// import "github.com/allegro/bigcache/v3/queue"</span>

<span class="token keyword">type</span> BytesQueue <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Has unexported fields.</span>
<span class="token punctuation">&#125;</span>
    BytesQueue is a non<span class="token operator">-</span>thread safe queue <span class="token keyword">type</span> of fifo based on bytes array<span class="token punctuation">.</span> For
    every push operation index of entry is returned<span class="token punctuation">.</span> It can be used to read the
    entry later

<span class="token keyword">func</span> <span class="token function">NewBytesQueue</span><span class="token punctuation">(</span>capacity <span class="token builtin">int</span><span class="token punctuation">,</span> maxCapacity <span class="token builtin">int</span><span class="token punctuation">,</span> verbose <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>BytesQueue
<span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>BytesQueue<span class="token punctuation">)</span> <span class="token function">Capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>BytesQueue<span class="token punctuation">)</span> <span class="token function">CheckGet</span><span class="token punctuation">(</span>index <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>BytesQueue<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>index <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>BytesQueue<span class="token punctuation">)</span> <span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>BytesQueue<span class="token punctuation">)</span> <span class="token function">Peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>BytesQueue<span class="token punctuation">)</span> <span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>BytesQueue<span class="token punctuation">)</span> <span class="token function">Push</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>BytesQueue<span class="token punctuation">)</span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="bigcache-的缺点-和使用中要注意的点"><a href="#bigcache-的缺点-和使用中要注意的点" class="headerlink" title="bigcache 的缺点 和使用中要注意的点:"></a>bigcache 的缺点 和使用中要注意的点:</h3><ol>
<li>bigcache 不支持 为单个key 设置 过期时间, bigcache 中所有的 key 的过期时间是一样的. (如果有需求自己开发)</li>
<li>bigcache set key 时 不会 更新 entry, 而是将原来的 entry 软删除, 在append 一个entry.</li>
<li>无持久化功能, 只能用作单机缓存</li>
<li>BytesQueue 的扩容操作可能会影响性能</li>
</ol>
<hr>
<p>[参考]<br><a target="_blank" rel="noopener" href="https://blog.allegro.tech/2016/03/writing-fast-cache-service-in-go.html">Writing a very fast cache service with millions of entries in Go</a><br><a target="_blank" rel="noopener" href="https://pandaychen.github.io/2020/03/03/BIGCACHE-ANALYSIS/">Golang 高性能 LocalCache：BigCache 设计与分析</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_38683995/article/details/113522023">Golang 中map与GC“纠缠不清”的关系</a><br><a target="_blank" rel="noopener" href="https://github.com/majunmin/bigcache">源码</a></p>

    </div>

    
    
    
        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/golang/" rel="tag"># golang</a>
              <a href="/tags/cache/" rel="tag"># cache</a>
              <a href="/tags/bigcache/" rel="tag"># bigcache</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/post/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%9B%B8%E5%85%B3%E7%9A%84%E4%B8%80%E4%BA%9B%E5%90%8D%E8%AF%8D.html" rel="prev" title="大数据相关的一些名词">
      <i class="fa fa-chevron-left"></i> 大数据相关的一些名词
    </a></div>
      <div class="post-nav-item">
    <a href="/post/freecache%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90.html" rel="next" title="freecache源码解析">
      freecache源码解析 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Bigcache-%E7%9A%84%E7%89%B9%E7%82%B9"><span class="nav-number">1.</span> <span class="nav-text">Bigcache 的特点:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5"><span class="nav-number">2.</span> <span class="nav-text">内存使用情况</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%8E%E4%B9%88%E5%81%9A%E5%88%B0%E7%9A%84%E9%AB%98%E6%80%A7%E8%83%BD"><span class="nav-number">3.</span> <span class="nav-text">怎么做到的高性能?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3-hash-%E5%86%B2%E7%AA%81-Hash-Collisions"><span class="nav-number">4.</span> <span class="nav-text">如何解决 hash 冲突(Hash Collisions)?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Bigcache-Vs-freecche"><span class="nav-number">5.</span> <span class="nav-text">Bigcache Vs freecche</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-number">6.</span> <span class="nav-text">源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%B8%80%E4%BA%9B%E6%A6%82%E5%BF%B5"><span class="nav-number">6.1.</span> <span class="nav-text">1. 一些概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-shard"><span class="nav-number">6.1.1.</span> <span class="nav-text">1. shard</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-CleanWindow"><span class="nav-number">6.1.2.</span> <span class="nav-text">2. CleanWindow</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-lifeWindow"><span class="nav-number">6.1.3.</span> <span class="nav-text">3. lifeWindow</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">6.2.</span> <span class="nav-text">2. 数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-cache"><span class="nav-number">6.2.1.</span> <span class="nav-text">1. cache</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-shard"><span class="nav-number">6.2.2.</span> <span class="nav-text">2. shard</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-entry"><span class="nav-number">6.2.3.</span> <span class="nav-text">3. entry</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-byteQueue"><span class="nav-number">6.2.4.</span> <span class="nav-text">4. byteQueue</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-number">6.3.</span> <span class="nav-text">3. 常用方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-%E7%BC%93%E5%AD%98%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">6.3.1.</span> <span class="nav-text">3.1  缓存初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-Get"><span class="nav-number">6.3.2.</span> <span class="nav-text">3.2 Get</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-Set"><span class="nav-number">6.3.3.</span> <span class="nav-text">3.3 Set</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#wrapEntry"><span class="nav-number">6.3.3.1.</span> <span class="nav-text">wrapEntry</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-Delete"><span class="nav-number">6.3.4.</span> <span class="nav-text">3.4 Delete</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-BytesQueue"><span class="nav-number">6.4.</span> <span class="nav-text">4. BytesQueue</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bigcache-%E7%9A%84%E7%BC%BA%E7%82%B9-%E5%92%8C%E4%BD%BF%E7%94%A8%E4%B8%AD%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E7%82%B9"><span class="nav-number">6.5.</span> <span class="nav-text">bigcache 的缺点 和使用中要注意的点:</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">majm</p>
  <div class="site-description" itemprop="description">做一些简单的笔记</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">49</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">64</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">majm</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">60k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:40</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '9ecd2d5ce0adb0ff67df',
      clientSecret: '3014bdb6e994b3bc0354e3c1629553c2bfbcfaed',
      repo        : 'blog-comments',
      owner       : 'majunmin',
      admin       : ['majunmin'],
      id          : 'c44daacaece4d682e7ffdd0fbd19eb57',
        language: '',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":120,"height":200,"position":"left","hOffset":20,"vOffset":50},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
